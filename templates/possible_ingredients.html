{% extends "base.html" %}
{% block title %}Possible Ingredients{% endblock %}
{% block content %}
    <h1>Possible Ingredients</h1>
    
    <!-- Form to add a new ingredient -->
    <h2>Add New Ingredient</h2>
    <form method="post">
        <label for="name">Name:</label>
        <input type="text" id="name" name="name" required>
        <label for="category">Category:</label>
        <select id="category" name="category" required onchange="updateSubcategories()">
            <option value="">Select a category</option>
            {% for cat in categories %}
                <option value="{{ cat }}">{{ cat }}</option>
            {% endfor %}
        </select>
        <label for="sub_category">Sub Category (Optional):</label>
        <select id="sub_category" name="sub_category">
            <option value="">None</option>
        </select>
        <button type="submit" style="background-color: #4CAF50; color: white; padding: 5px 10px; border: none; border-radius: 4px; cursor: pointer;">Add Ingredient</button>
    </form>
    
    <!-- List of possible ingredients -->
    <h2>Master List</h2>
    {% if ingredients %}
        <!-- Unified filter input -->
        <div style="margin-bottom: 10px;">
            <label for="filter-all">Filter:</label>
            <input type="text" id="filter-all" onkeyup="filterTable()" placeholder="Filter by name, category, or sub category..." style="width: 300px;">
        </div>

        <table border="1" style="border-collapse: collapse; width: 100%;">
            <thead>
                <tr>
                    <th style="width: 50px; text-align: center;">Edit</th>
                    <th style="width: 50px; text-align: center;">Delete</th>
                    <th style="cursor: pointer;" onclick="sortTable('name')">Name <span id="sort-name">↕</span></th>
                    <th style="cursor: pointer;" onclick="sortTable('category')">Category <span id="sort-category">↕</span></th>
                    <th style="cursor: pointer;" onclick="sortTable('sub_category')">Sub Category <span id="sort-sub_category">↕</span></th>
                </tr>
            </thead>
            <tbody id="ingredients-list">
                {% for ingredient in ingredients %}
                    <tr>
                        <td style="width: 50px; text-align: center;">
                            <button class="edit-ingredient" data-id="{{ ingredient['id'] }}" style="background-color: #2196F3; color: white; border: none; border-radius: 4px; cursor: pointer; padding: 5px 10px;">Edit</button>
                        </td>
                        <td style="width: 50px; text-align: center;">
                            <button class="delete-ingredient" data-id="{{ ingredient['id'] }}" style="background-color: #ff4444; color: white; border: none; border-radius: 4px; cursor: pointer; padding: 5px 10px;">X</button>
                        </td>
                        <td>{{ ingredient['name'] }}</td>
                        <td>{{ ingredient['category'] }}</td>
                        <td>{{ ingredient['sub_category'] or '' }}</td>
                    </tr>
                {% endfor %}
            </tbody>
        </table>
    {% else %}
        <p>No ingredients in the master list yet.</p>
    {% endif %}

    <!-- Edit Ingredient Modal -->
    <div id="edit-ingredient-modal" class="modal" style="display: none;">
        <div class="modal-content">
            <span class="close" onclick="closeEditIngredientModal()">×</span>
            <h2>Edit Ingredient</h2>
            <form id="edit-ingredient-form">
                <input type="hidden" id="edit-ingredient-id" name="id">
                <label for="edit-ingredient-name">Name:</label>
                <input type="text" id="edit-ingredient-name" name="name" required><br><br>
                <label for="edit-ingredient-category">Category:</label>
                <select name="category" id="edit-ingredient-category" required onchange="updateEditSubcategories()">
                    <option value="" disabled>Select Category</option>
                    {% for category in categories %}
                        <option value="{{ category }}">{{ category }}</option>
                    {% endfor %}
                </select><br><br>
                <label for="edit-ingredient-subcategory">Sub Category (Optional):</label>
                <select name="sub_category" id="edit-ingredient-subcategory">
                    <option value="">None</option>
                </select><br><br>
                <button type="button" onclick="saveEditIngredient()" style="background-color: #4CAF50; color: white; padding: 5px 10px; border: none; border-radius: 4px; cursor: pointer;">Save Changes</button>
                <button type="button" onclick="closeEditIngredientModal()" style="background-color: #ff4444; color: white; padding: 5px 10px; border: none; border-radius: 4px; cursor: pointer;">Cancel</button>
            </form>
        </div>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', function() {
            // Handle Delete buttons
            const deleteButtons = document.querySelectorAll('.delete-ingredient');
            deleteButtons.forEach(button => {
                button.addEventListener('click', function() {
                    const id = this.getAttribute('data-id');
                    if (confirm(`Are you sure you want to delete this ingredient?`)) {
                        fetch(`/delete_possible_ingredient/${id}`, {
                            method: 'DELETE'
                        })
                        .then(response => response.json())
                        .then(data => {
                            alert(data.message);
                            location.reload();
                        })
                        .catch(error => {
                            console.error('Error deleting ingredient:', error);
                            alert('Error deleting ingredient.');
                        });
                    }
                });
            });

            // Handle Edit buttons
            const editButtons = document.querySelectorAll('.edit-ingredient');
            editButtons.forEach(button => {
                button.addEventListener('click', function() {
                    const id = this.getAttribute('data-id');
                    const row = this.closest('tr');
                    const name = row.cells[2].textContent; // Name is in the third column (index 2)
                    const category = row.cells[3].textContent; // Category is in the fourth column (index 3)
                    const subCategory = row.cells[4].textContent || ''; // Sub Category is in the fifth column (index 4)

                    // Populate the modal with current values
                    document.getElementById('edit-ingredient-id').value = id;
                    document.getElementById('edit-ingredient-name').value = name;
                    document.getElementById('edit-ingredient-category').value = category;
                    document.getElementById('edit-ingredient-subcategory').innerHTML = '<option value="">None</option>';

                    // Fetch and populate subcategories for the selected category
                    if (category) {
                        fetch(`/subcategories/${encodeURIComponent(category)}`)
                            .then(response => response.json())
                            .then(subcategories => {
                                const subcatSelect = document.getElementById('edit-ingredient-subcategory');
                                subcategories.forEach(subcat => {
                                    const option = document.createElement('option');
                                    option.value = subcat;
                                    option.textContent = subcat;
                                    if (subcat === subCategory) {
                                        option.selected = true;
                                    }
                                    subcatSelect.appendChild(option);
                                });
                            })
                            .catch(error => {
                                console.error('Error fetching subcategories:', error);
                            });
                    }

                    // Show the modal
                    document.getElementById('edit-ingredient-modal').style.display = 'block';
                });
            });

            // Function to update subcategories based on selected category in Add form
            window.updateSubcategories = function() {
                const categorySelect = document.getElementById('category');
                const subCategorySelect = document.getElementById('sub_category');
                const category = categorySelect.value;

                // Clear existing options
                subCategorySelect.innerHTML = '<option value="">None</option>';

                if (category) {
                    fetch(`/subcategories/${encodeURIComponent(category)}`)
                        .then(response => response.json())
                        .then(subcategories => {
                            subcategories.forEach(subcat => {
                                const option = document.createElement('option');
                                option.value = subcat;
                                option.textContent = subcat;
                                subCategorySelect.appendChild(option);
                            });
                        })
                        .catch(error => {
                            console.error('Error fetching subcategories:', error);
                        });
                }
            };

            // Function to update subcategories in Edit modal
            window.updateEditSubcategories = function() {
                const categorySelect = document.getElementById('edit-ingredient-category');
                const subCategorySelect = document.getElementById('edit-ingredient-subcategory');
                const category = categorySelect.value;

                // Clear existing options
                subCategorySelect.innerHTML = '<option value="">None</option>';

                if (category) {
                    fetch(`/subcategories/${encodeURIComponent(category)}`)
                        .then(response => response.json())
                        .then(subcategories => {
                            subcategories.forEach(subcat => {
                                const option = document.createElement('option');
                                option.value = subcat;
                                option.textContent = subcat;
                                subCategorySelect.appendChild(option);
                            });
                        })
                        .catch(error => {
                            console.error('Error fetching subcategories:', error);
                        });
                }
            };

            // Function to save edited ingredient
            window.saveEditIngredient = function() {
                const form = document.getElementById('edit-ingredient-form');
                const id = document.getElementById('edit-ingredient-id').value;
                const formData = new FormData(form);

                fetch(`/update_possible_ingredient/${id}`, {
                    method: 'POST',
                    body: formData
                })
                .then(response => {
                    if (!response.ok) {
                        throw new Error(`HTTP error! Status: ${response.status}`);
                    }
                    return response.json();
                })
                .then(() => {
                    closeEditIngredientModal();
                    location.reload();
                })
                .catch(error => {
                    console.error('Error updating ingredient:', error);
                    alert('Error updating ingredient.');
                });
            };

            // Function to close the Edit modal
            window.closeEditIngredientModal = function() {
                document.getElementById('edit-ingredient-modal').style.display = 'none';
                document.getElementById('edit-ingredient-form').reset();
            };

            // Sorting functionality
            let sortDirection = {
                'name': 1,
                'category': 1,
                'sub_category': 1
            };

            window.sortTable = function(column) {
                const tbody = document.getElementById('ingredients-list');
                const rows = Array.from(tbody.querySelectorAll('tr'));
                const direction = sortDirection[column];

                // Sort the rows
                rows.sort((a, b) => {
                    let aValue = a.cells[getColumnIndex(column)].textContent.toLowerCase();
                    let bValue = b.cells[getColumnIndex(column)].textContent.toLowerCase();

                    // Handle empty values (place them at the end)
                    if (aValue === '' && bValue !== '') return 1;
                    if (bValue === '' && aValue !== '') return -1;
                    if (aValue === bValue) return 0;

                    return direction * (aValue > bValue ? 1 : -1);
                });

                // Toggle sort direction
                sortDirection[column] = -direction;

                // Update sort indicators
                updateSortIndicators(column, direction);

                // Clear and re-append sorted rows
                while (tbody.firstChild) {
                    tbody.removeChild(tbody.firstChild);
                }
                rows.forEach(row => tbody.appendChild(row));

                // Re-apply filters after sorting
                filterTable();
            };

            function getColumnIndex(column) {
                const headers = ['edit', 'delete', 'name', 'category', 'sub_category'];
                return headers.indexOf(column);
            }

            function updateSortIndicators(column, direction) {
                const indicators = {
                    'name': document.getElementById('sort-name'),
                    'category': document.getElementById('sort-category'),
                    'sub_category': document.getElementById('sort-sub_category')
                };

                // Reset all indicators
                for (let key in indicators) {
                    indicators[key].textContent = '↕';
                }

                // Set the indicator for the current column
                indicators[column].textContent = direction === 1 ? '↑' : '↓';
            }

            // Filtering functionality
            window.filterTable = function() {
                const filterValue = document.getElementById('filter-all').value.toLowerCase();
                const tbody = document.getElementById('ingredients-list');
                const rows = tbody.querySelectorAll('tr');

                rows.forEach(row => {
                    const name = row.cells[2].textContent.toLowerCase();       // third column
                    const category = row.cells[3].textContent.toLowerCase();   // fourth column
                    const subCategory = row.cells[4].textContent.toLowerCase();// fifth column

                    const matches = name.includes(filterValue) ||
                                    category.includes(filterValue) ||
                                    subCategory.includes(filterValue);

                    row.style.display = matches ? '' : 'none';
                });
            };
        });
    </script>

    <style>
        .modal {
            display: none;
            position: fixed;
            z-index: 1;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0,0,0,0.5);
        }
        .modal-content {
            background-color: white;
            margin: 15% auto;
            padding: 20px;
            border: 1px solid #888;
            width: 50%;
        }
        .close {
            color: #aaa;
            float: right;
            font-size: 28px;
            font-weight: bold;
            cursor: pointer;
        }
        .close:hover {
            color: black;
        }
    </style>
{% endblock %}