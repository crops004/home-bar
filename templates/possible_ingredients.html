{% extends "base.html" %}
{% block title %}Possible Ingredients{% endblock %}
{% block content %}
    <div class="flex flex-col sm:flex-row sm:items-center sm:justify-between gap-4">
        <div>
            <h1 class="text-3xl font-semibold text-text-normal">Possible Ingredients</h1>
            <p class="text-sm text-text-muted">Manage the master ingredient list used across your bar and recipes.</p>
        </div>
        <button
            type="button"
            class="inline-flex items-center gap-2 rounded-full bg-logo px-4 py-2 text-sm font-medium text-light-text-normal hover:ring-2 hover:ring-logo transition"
            onclick="openAddModal()"
        >
            <span class="text-lg leading-none">+</span>
            Add Ingredient
        </button>
    </div>

    <div class="mt-6 flex flex-wrap gap-4 items-end bg-background-mid/40 border border-border rounded-2xl p-4">
        <div class="flex flex-col gap-1 w-full sm:max-w-sm">
            <label for="ingredient-filter" class="text-xs uppercase tracking-wide text-text-muted">Search Ingredients</label>
            <input
                type="text"
                id="ingredient-filter"
                placeholder="Search by name, category, or subcategory..."
                oninput="filterIngredientCards()"
                class="rounded-lg border border-border bg-background-light px-3 py-2 text-sm text-text-normal focus:outline-none focus:ring-2 focus:ring-logo"
            >
        </div>
        <button
            type="button"
            onclick="resetIngredientFilter()"
            class="ml-auto inline-flex items-center gap-2 rounded-full border border-border px-4 py-2 text-sm text-text-normal hover:bg-background-light transition"
        >
            Clear Search
        </button>
    </div>

    {% if ingredients %}
    <div id="ingredient-grid" class="mt-6 grid gap-4 sm:grid-cols-2 xl:grid-cols-3">
        {% for ingredient in ingredients %}
        <article
            class="ingredient-card bg-background-mid border border-border rounded-2xl shadow-lg overflow-hidden transition transform hover:-translate-y-1 hover:shadow-xl"
            data-id="{{ ingredient['id'] }}"
            data-name="{{ ingredient['name'] }}"
            data-category="{{ ingredient['category'] or '' }}"
            data-subcategory="{{ ingredient['sub_category'] or '' }}"
        >
            <div class="p-4 space-y-3">
                <header class="flex items-start justify-between gap-3">
                    <h3 class="text-lg font-semibold text-text-normal truncate">{{ ingredient['name'] }}</h3>
                    <span class="text-xs text-text-muted bg-background-light px-2 py-1 rounded-full uppercase tracking-wide">{{ ingredient['category'] or 'Uncategorized' }}</span>
                </header>
                <p class="text-sm text-text-muted">
                    <span class="font-medium text-text-normal">Subcategory:</span>
                    {{ ingredient['sub_category'] or 'None' }}
                </p>
            </div>
            <div class="flex items-center justify-between gap-3 border-t border-border bg-background-dark px-4 py-3">
                <button
                    type="button"
                    class="inline-flex items-center gap-2 text-sm text-text-muted hover:text-logo transition"
                    onclick="openEditModal(this)"
                >
                    <span class="text-base leading-none">âœŽ</span>
                    Edit
                </button>
                <button
                    type="button"
                    class="inline-flex items-center gap-2 rounded-full bg-red-600 px-3 py-1 text-xs font-medium text-white hover:bg-red-500 transition"
                    onclick="deleteIngredient(this)"
                >
                    Delete
                </button>
            </div>
        </article>
        {% endfor %}
    </div>
    <p id="ingredients-empty" class="mt-6 hidden text-sm text-text-muted">No ingredients match your search.</p>
    {% else %}
    <p class="mt-6 text-text-muted">No ingredients in the master list yet. Add your first ingredient above.</p>
    {% endif %}

    <!-- Add Ingredient Modal -->
    <div id="add-ingredient-modal" class="modal-backdrop hidden">
        <div class="modal-panel max-w-lg">
            <div class="modal-header">
                <h2 class="text-xl font-semibold text-text-normal">Add Ingredient</h2>
                <button type="button" onclick="closeAddModal()" class="text-text-muted hover:text-text-normal text-2xl leading-none">&times;</button>
            </div>
            <form method="post" class="modal-body space-y-4" id="add-ingredient-form">
                <label class="flex flex-col gap-1 text-sm">
                    <span class="modal-label">Name</span>
                    <input type="text" id="add-name" name="name" required class="modal-input" />
                </label>
                <label class="flex flex-col gap-1 text-sm">
                    <span class="modal-label">Category</span>
                    <select id="add-category" name="category" required class="modal-input" onchange="syncSubcategories(this, 'add-subcategory')">
                        <option value="">Select category</option>
                        {% for cat in categories %}
                            <option value="{{ cat }}">{{ cat }}</option>
                        {% endfor %}
                    </select>
                </label>
                <label class="flex flex-col gap-1 text-sm">
                    <span class="modal-label">Subcategory (optional)</span>
                    <select id="add-subcategory" name="sub_category" class="modal-input">
                        <option value="">None</option>
                    </select>
                </label>
                <div class="modal-footer">
                    <button type="button" onclick="closeAddModal()" class="modal-button-secondary">Cancel</button>
                    <button type="submit" class="modal-button-primary">Save Ingredient</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Edit Ingredient Modal -->
    <div id="edit-ingredient-modal" class="modal-backdrop hidden">
        <div class="modal-panel max-w-lg">
            <div class="modal-header">
                <h2 class="text-xl font-semibold text-text-normal">Edit Ingredient</h2>
                <button type="button" onclick="closeEditModal()" class="text-text-muted hover:text-text-normal text-2xl leading-none">&times;</button>
            </div>
            <form id="edit-ingredient-form" class="modal-body space-y-4">
                <input type="hidden" id="edit-id" name="id" />
                <label class="flex flex-col gap-1 text-sm">
                    <span class="modal-label">Name</span>
                    <input type="text" id="edit-name" name="name" required class="modal-input" />
                </label>
                <label class="flex flex-col gap-1 text-sm">
                    <span class="modal-label">Category</span>
                    <select id="edit-category" name="category" required class="modal-input" onchange="syncSubcategories(this, 'edit-subcategory')">
                        <option value="" disabled>Select category</option>
                        {% for cat in categories %}
                            <option value="{{ cat }}">{{ cat }}</option>
                        {% endfor %}
                    </select>
                </label>
                <label class="flex flex-col gap-1 text-sm">
                    <span class="modal-label">Subcategory (optional)</span>
                    <select id="edit-subcategory" name="sub_category" class="modal-input">
                        <option value="">None</option>
                    </select>
                </label>
                <div class="modal-footer">
                    <button type="button" onclick="closeEditModal()" class="modal-button-secondary">Cancel</button>
                    <button type="button" onclick="saveEditIngredient()" class="modal-button-primary">Save Changes</button>
                </div>
            </form>
        </div>
    </div>

    <script>
        const CATEGORY_DATA = {{ categories | tojson }};

        function closeAllModals() {
            document.querySelectorAll('.modal-backdrop').forEach((modal) => {
                modal.classList.add('hidden');
                modal.style.display = 'none';
            });
        }

        function openAddModal() {
            const modal = document.getElementById('add-ingredient-modal');
            if (modal) {
                modal.classList.remove('hidden');
                modal.style.display = 'flex';
                document.getElementById('add-ingredient-form').reset();
                syncSubcategories(document.getElementById('add-category'), 'add-subcategory');
                document.getElementById('add-name').focus();
            }
        }

        function closeAddModal() {
            const modal = document.getElementById('add-ingredient-modal');
            if (modal) {
                modal.classList.add('hidden');
                modal.style.display = 'none';
            }
        }

        function openEditModal(button) {
            const card = button.closest('.ingredient-card');
            if (!card) {
                return;
            }

            const modal = document.getElementById('edit-ingredient-modal');
            if (!modal) {
                return;
            }

            document.getElementById('edit-id').value = card.dataset.id || '';
            document.getElementById('edit-name').value = card.dataset.name || '';
            const categorySelect = document.getElementById('edit-category');
            categorySelect.value = card.dataset.category || '';
            syncSubcategories(categorySelect, 'edit-subcategory', card.dataset.subcategory || '');

            modal.classList.remove('hidden');
            modal.style.display = 'flex';
        }

        function closeEditModal() {
            const modal = document.getElementById('edit-ingredient-modal');
            if (modal) {
                modal.classList.add('hidden');
                modal.style.display = 'none';
            }
        }

        function syncSubcategories(selectEl, targetSelectId, selectedValue = '') {
            const target = document.getElementById(targetSelectId);
            if (!selectEl || !target) {
                return;
            }

            target.innerHTML = '<option value=\"\">None</option>';
            const category = selectEl.value;
            if (!category) {
                return;
            }

            fetch(`/subcategories/${encodeURIComponent(category)}`)
                .then((response) => response.json())
                .then((subcategories) => {
                    subcategories.forEach((sub) => {
                        const option = document.createElement('option');
                        option.value = sub;
                        option.textContent = sub;
                        if (selectedValue && selectedValue === sub) {
                            option.selected = true;
                        }
                        target.appendChild(option);
                    });
                })
                .catch((error) => {
                    console.error('Unable to load subcategories:', error);
                });
        }

        function notify(message, isError = false) {
            if (typeof showToast === "function") {
                showToast(message, isError ? 3500 : 2500);
            } else if (isError) {
                window.alert(message);
            } else {
                console.log(message);
            }
        }

        function removeCardById(id) {
            const card = document.querySelector(`.ingredient-card[data-id="${id}"]`);
            if (card && card.parentElement) {
                card.parentElement.removeChild(card);
            }

            const remainingCards = document.querySelectorAll('.ingredient-card');
            const emptyState = document.getElementById('ingredients-empty');
            if (emptyState) {
                emptyState.classList.toggle('hidden', remainingCards.length !== 0);
            }
            filterIngredientCards();
        }

        function updateCardFromForm(data) {
            const card = document.querySelector(`.ingredient-card[data-id=\"${data.id}\"]`);
            if (!card) {
                return;
            }
            card.dataset.name = data.name;
            card.dataset.category = data.category;
            card.dataset.subcategory = data.sub_category || '';
            card.querySelector('h3').textContent = data.name;
            card.querySelector('span').textContent = data.category || 'Uncategorized';
            const subText = card.querySelector('p');
            if (subText) {
                subText.innerHTML = `<span class=\"font-medium text-text-normal\">Subcategory:</span> ${data.sub_category || 'None'}`;
            }
        }

        function deleteIngredient(button) {
            const card = button.closest(".ingredient-card");
            if (!card) {
                return;
            }
            const id = card.dataset.id;
            if (!id) {
                return;
            }

            fetch(`/delete_possible_ingredient/${id}`, { method: "DELETE" })
                .then((response) => {
                    if (!response.ok) {
                        throw new Error(`Request failed with status ${response.status}`);
                    }
                    removeCardById(id);
                    filterIngredientCards();
                    notify(`${card.dataset.name || "Ingredient"} removed from master list.`);
                })
                .catch((error) => {
                    console.error("Unable to delete ingredient:", error);
                    notify("Unable to delete ingredient. Please try again.", true);
                });
        }

        function saveEditIngredient() {
            const form = document.getElementById('edit-ingredient-form');
            if (!form) {
                return;
            }
            const id = form.querySelector('#edit-id').value;
            if (!id) {
                return;
            }

            const formData = new FormData(form);

            fetch(`/update_possible_ingredient/${id}`, {
                method: 'POST',
                body: formData,
            })
                .then((response) => {
                    if (!response.ok) {
                        return response.json().then((payload) => {
                            throw new Error(payload.message || 'Unable to update ingredient.');
                        });
                    }
                    return response.json();
                })
                .then(() => {
                    updateCardFromForm({
                        id,
                        name: formData.get('name') || '',
                        category: formData.get('category') || '',
                        sub_category: formData.get('sub_category') || '',
                    });
                    closeEditModal();
                    filterIngredientCards();
                    notify('Ingredient updated.');
                })
                .catch((error) => {
                    console.error('Unable to update ingredient:', error);
                    notify(error.message || 'Unable to update ingredient. Please try again.', true);
                });
        }

        function filterIngredientCards() {
            const filterValue = (document.getElementById('ingredient-filter')?.value || '').trim().toLowerCase();
            const cards = document.querySelectorAll('.ingredient-card');
            let visibleCount = 0;

            cards.forEach((card) => {
                const name = (card.dataset.name || '').toLowerCase();
                const category = (card.dataset.category || '').toLowerCase();
                const subcategory = (card.dataset.subcategory || '').toLowerCase();
                const shouldShow =
                    !filterValue ||
                    name.includes(filterValue) ||
                    category.includes(filterValue) ||
                    subcategory.includes(filterValue);
                card.classList.toggle('hidden', !shouldShow);
                if (shouldShow) {
                    visibleCount += 1;
                }
            });

            const emptyState = document.getElementById('ingredients-empty');
            if (emptyState) {
                emptyState.classList.toggle('hidden', visibleCount !== 0);
            }
        }

        function resetIngredientFilter() {
            const filterInput = document.getElementById('ingredient-filter');
            if (filterInput) {
                filterInput.value = '';
            }
            filterIngredientCards();
        }

        document.addEventListener('DOMContentLoaded', () => {
            filterIngredientCards();
        });

        window.openAddModal = openAddModal;
        window.closeAddModal = closeAddModal;
        window.openEditModal = openEditModal;
        window.closeEditModal = closeEditModal;
        window.deleteIngredient = deleteIngredient;
        window.saveEditIngredient = saveEditIngredient;
        window.filterIngredientCards = filterIngredientCards;
        window.resetIngredientFilter = resetIngredientFilter;
        window.syncSubcategories = syncSubcategories;
    </script>
{% endblock %}
