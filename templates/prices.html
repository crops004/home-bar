{% extends "base.html" %}
{% block title %}Prices{% endblock %}
{% block content %}
    {% with messages = get_flashed_messages() %}
    {% if messages %}
        <div class="hidden" data-toast-message="{{ messages[0] | escape }}" aria-hidden="true"></div>
    {% endif %}
    {% endwith %}

    <div class="px-4 sm:px-6 pt-0 pb-24 sm:pb-8">
        <div class="sticky top-0 sm:top-[var(--desktop-nav-offset)] z-30 bg-background-dark/95 supports-[backdrop-filter]:bg-background-dark/80 backdrop-blur pt-4 sm:pt-0 pb-4 space-y-6">
            <div class="flex flex-col sm:flex-row sm:items-center sm:justify-between gap-4">
                <div>
                    <h1 class="text-3xl font-semibold text-text-normal">Prices</h1>
                    <p class="text-sm text-text-muted">Track purchase history and compare price per ml across your ingredients.</p>
                </div>
            </div>
            <div class="rounded-2xl border border-border bg-background-mid p-4 sm:p-5">
                <div class="flex items-start justify-between gap-3">
                    <div>
                        <h2 class="text-lg font-semibold text-text-normal">Add Purchase</h2>
                        <p class="text-sm text-text-muted">Use + to expand and add a new purchase.</p>
                    </div>
                    <button
                        id="purchase-form-toggle"
                        type="button"
                        class="inline-flex h-9 w-9 items-center justify-center rounded-full border border-border text-text-normal hover:bg-background-light transition"
                        aria-expanded="false"
                        aria-controls="purchase-form-panel"
                        title="Toggle Add Purchase Form"
                    >
                        <svg id="purchase-toggle-plus" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor" class="size-5">
                            <path d="M10 4.75a.75.75 0 0 1 .75.75v3.75h3.75a.75.75 0 0 1 0 1.5h-3.75v3.75a.75.75 0 0 1-1.5 0v-3.75H5.5a.75.75 0 0 1 0-1.5h3.75V5.5a.75.75 0 0 1 .75-.75Z" />
                        </svg>
                        <svg id="purchase-toggle-minus" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor" class="size-5 hidden">
                            <path d="M5.75 10a.75.75 0 0 1 .75-.75h7a.75.75 0 0 1 0 1.5h-7a.75.75 0 0 1-.75-.75Z" />
                        </svg>
                        <span class="sr-only">Toggle add purchase form</span>
                    </button>
                </div>
                <div id="purchase-form-panel" class="hidden mt-4">
                    <form method="post" class="grid gap-3 sm:grid-cols-2 lg:grid-cols-3">
                        <label class="flex flex-col gap-1 text-sm lg:col-span-2">
                            <span class="modal-label">Ingredient</span>
                            <select name="ingredient_id" required class="modal-input">
                                <option value="">Select ingredient</option>
                                {% for ingredient in ingredients %}
                                    <option value="{{ ingredient['id'] }}">{{ ingredient['name'] }}</option>
                                {% endfor %}
                            </select>
                        </label>
                        <label class="flex flex-col gap-1 text-sm">
                            <span class="modal-label">Date</span>
                            <input type="date" name="purchase_date" required class="modal-input" value="{{ today }}" />
                        </label>
                        <label class="flex flex-col gap-1 text-sm">
                            <span class="modal-label">Size</span>
                            <input type="number" name="size_value" step="0.01" min="0" required class="modal-input" placeholder="750" />
                        </label>
                        <label class="flex flex-col gap-1 text-sm">
                            <span class="modal-label">Unit</span>
                            <select name="size_unit" required class="modal-input">
                                <option value="">Select unit</option>
                                {% for unit in purchase_units %}
                                    <option value="{{ unit['value'] }}">{{ unit['label'] }}</option>
                                {% endfor %}
                            </select>
                        </label>
                        <label class="flex flex-col gap-1 text-sm">
                            <span class="modal-label">Price (USD)</span>
                            <input type="number" name="price" step="0.01" min="0" required class="modal-input" placeholder="29.99" />
                        </label>
                        <label class="flex flex-col gap-1 text-sm">
                            <span class="modal-label">Location (optional)</span>
                            <input type="text" name="location" class="modal-input" placeholder="Store or website" />
                        </label>
                        <label class="flex flex-col gap-1 text-sm lg:col-span-3">
                            <span class="modal-label">Notes (optional)</span>
                            <input type="text" name="notes" class="modal-input" placeholder="Sale, bottle notes, etc." />
                        </label>
                        <div class="lg:col-span-3 flex justify-end">
                            <button type="submit" class="modal-button-primary">Save Purchase</button>
                        </div>
                    </form>
                </div>
            </div>
        </div>

        <div class="mt-6 space-y-3">
            <h2 class="text-lg font-semibold text-text-normal">Purchase History</h2>
            {% if purchases %}
                <div id="purchase-history-list" class="space-y-3">
                    {% for purchase in purchases %}
                        <article
                            class="purchase-history-card ui-card ui-card-interactive cursor-pointer p-4 sm:p-5"
                            data-ingredient-name="{{ purchase['ingredient_name'] | trim | lower }}"
                            title="Click to filter by ingredient"
                            tabindex="0"
                        >
                            <div class="flex flex-col sm:flex-row sm:items-start sm:justify-between gap-2">
                                <div>
                                    <h3 class="text-base font-semibold text-text-normal">{{ purchase['ingredient_name'] }}</h3>
                                    <p class="text-sm text-text-muted">
                                        {{ purchase['purchase_date'] }}
                                        {% if purchase['location'] %} | {{ purchase['location'] }}{% endif %}
                                    </p>
                                    <p class="text-sm text-text-muted mt-1">
                                        {{ purchase['size_value_display'] }} {{ purchase['size_unit_display'] }}
                                        | ${{ "{:,.2f}".format(purchase['price']) }}
                                    </p>
                                    {% if purchase['notes'] %}
                                        <p class="text-xs text-text-muted mt-1">{{ purchase['notes'] }}</p>
                                    {% endif %}
                                </div>
                                <div class="text-left sm:text-right">
                                    <p class="text-xs uppercase tracking-wide text-text-muted">Price Per Oz</p>
                                    <p class="text-base font-semibold text-text-normal">
                                        {% if purchase['price_per_oz'] is not none %}
                                            ${{ "{:,.2f}".format(purchase['price_per_oz']) }}/oz
                                        {% else %}
                                            n/a
                                        {% endif %}
                                    </p>
                                </div>
                            </div>
                        </article>
                    {% endfor %}
                </div>
            {% else %}
                <p class="text-sm text-text-muted">No purchases yet. Add your first purchase above.</p>
            {% endif %}
        </div>
    </div>
{% endblock %}

{% block scripts %}
    {{ super() }}
    <script>
        document.addEventListener('DOMContentLoaded', () => {
            const toggle = document.getElementById('purchase-form-toggle');
            const panel = document.getElementById('purchase-form-panel');
            const plusIcon = document.getElementById('purchase-toggle-plus');
            const minusIcon = document.getElementById('purchase-toggle-minus');

            if (toggle && panel && plusIcon && minusIcon) {
                const setState = (expanded) => {
                    panel.classList.toggle('hidden', !expanded);
                    plusIcon.classList.toggle('hidden', expanded);
                    minusIcon.classList.toggle('hidden', !expanded);
                    toggle.setAttribute('aria-expanded', String(expanded));
                };

                setState(false);

                toggle.addEventListener('click', () => {
                    const expanded = toggle.getAttribute('aria-expanded') !== 'true';
                    setState(expanded);
                });
            }

            const purchaseCards = Array.from(document.querySelectorAll('.purchase-history-card'));
            if (!purchaseCards.length) {
                return;
            }

            let activeIngredientFilter = null;

            const applyPurchaseHistoryFilter = () => {
                purchaseCards.forEach((card) => {
                    const ingredientName = (card.dataset.ingredientName || '').trim().toLowerCase();
                    const shouldShow = !activeIngredientFilter || ingredientName === activeIngredientFilter;
                    const isActive = Boolean(activeIngredientFilter) && ingredientName === activeIngredientFilter;

                    card.classList.toggle('hidden', !shouldShow);
                    card.classList.toggle('border-logo', isActive);
                    card.classList.toggle('ring-1', isActive);
                    card.classList.toggle('ring-logo/40', isActive);
                });
            };

            const toggleCardFilter = (card) => {
                const ingredientName = (card.dataset.ingredientName || '').trim().toLowerCase();
                if (!ingredientName) {
                    return;
                }
                activeIngredientFilter = activeIngredientFilter === ingredientName ? null : ingredientName;
                applyPurchaseHistoryFilter();
            };

            purchaseCards.forEach((card) => {
                card.addEventListener('click', () => toggleCardFilter(card));
                card.addEventListener('keydown', (event) => {
                    if (event.key === 'Enter' || event.key === ' ') {
                        event.preventDefault();
                        toggleCardFilter(card);
                    }
                });
            });
        });
    </script>
{% endblock %}
