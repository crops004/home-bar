{% extends "base.html" %}
{% block title %}Bar Contents{% endblock %}
{% block content %}
    
    {% with messages = get_flashed_messages() %}
    {% if messages %}
        <div class="hidden" data-toast-message="{{ messages[0] | escape }}" aria-hidden="true"></div>
    {% endif %}
    {% endwith %}

    <div class="px-4 sm:px-6 pt-4 pb-28 sm:pt-0 sm:pb-10">
        <div class="flex flex-col sm:flex-row sm:items-center sm:justify-between gap-4">
            <h1 class="text-3xl font-semibold text-text-normal">Bar Contents</h1>
            <div class="flex flex-wrap items-center gap-2">
                <button
                    type="button"
                    onclick="openAddModal()"
                    class="inline-flex h-11 min-w-[11rem] items-center justify-center gap-2 rounded-full bg-logo px-5 py-2 text-sm font-medium text-light-text-normal hover:ring-2 hover:ring-logo transition"
                    title="Add Item"
                >
                    <span class="text-xl leading-none">+</span>
                    Add Item
                </button>
            </div>
        </div>

        <div class="mt-6 space-y-3">
            <div class="flex flex-wrap items-center gap-3 bg-background-mid/40 border border-border rounded-2xl p-4">
                <div class="flex flex-wrap items-center gap-2">
                    <span class="text-xs uppercase tracking-wide text-text-muted">Category</span>
                    <button class="filter-btn" data-filter="all">All</button>
                    <button class="filter-btn" data-filter="spirit">Spirits</button>
                    <button class="filter-btn" data-filter="modifier">Modifiers & Mixers</button>
                    <button class="filter-btn" data-filter="gin">Gin</button>
                    <button class="filter-btn" data-filter="whiskey">Whiskey</button>
                    <button class="filter-btn" data-filter="rum">Rum</button>
                    <button class="filter-btn" data-filter="tequila">Tequila</button>
                </div>
                <div class="flex w-full flex-col gap-2 sm:w-auto sm:flex-row sm:items-center sm:gap-3 sm:ml-auto">
                    <input
                        type="text"
                        id="filter-all"
                        placeholder="Search by name or category..."
                        oninput="filterAllTables()"
                        class="modal-input w-full sm:w-60"
                    />
                    <button type="button" id="clear-filter-btn" onclick="clearFilter()" class="hidden inline-flex items-center gap-2 rounded-full border border-border px-3 py-1 text-xs text-text-muted hover:bg-background-light transition">
                        Clear
                    </button>
                </div>
            </div>
        </div>

    {% if items %}
    {% set grouped_items = items | sort(attribute='category') | groupby('category') %}
    <div id="bar-accordion" class="mt-6 space-y-4">
        {% for group in grouped_items %}
        {% set category = group.grouper or 'Uncategorized' %}
        {% set panel_id = 'bar-section-' ~ loop.index %}
        {% set item_count = group.list | length %}
        <section class="bar-category ui-card" data-category="{{ category }}">
            <button
                type="button"
                class="bar-category-toggle ui-card-header flex w-full items-center justify-between gap-3 px-4 py-3 text-left"
                data-target="{{ panel_id }}"
                aria-expanded="true"
            >
                <div class="flex flex-col">
                    <span class="text-xs uppercase tracking-wide text-text-muted">Category</span>
                    <span class="text-lg font-semibold text-text-normal">{{ category }}</span>
                </div>
                <div class="flex items-center gap-3">
                    <span class="bar-category-count rounded-full bg-background-dark px-3 py-1 text-xs text-text-muted">{{ item_count }} item{% if item_count != 1 %}s{% endif %}</span>
                    <svg class="size-4 text-text-muted transition-transform" data-chevron aria-hidden="true" viewBox="0 0 20 20" fill="currentColor">
                        <path fill-rule="evenodd" d="M5.293 7.293a1 1 0 0 1 1.414 0L10 10.586l3.293-3.293a1 1 0 1 1 1.414 1.414l-4 4a1 1 0 0 1-1.414 0l-4-4a1 1 0 0 1 0-1.414Z" clip-rule="evenodd" />
                    </svg>
                </div>
            </button>
            <div id="{{ panel_id }}" class="bar-category-panel divide-y divide-border bg-background-dark">
                <div class="hidden sm:grid sm:grid-cols-[minmax(0,1fr)_minmax(0,1fr)_auto] gap-3 px-4 py-2 text-xs uppercase tracking-wide text-text-muted">
                    <span>Name</span>
                    <span>Subcategory</span>
                    <span class="text-right">Actions</span>
                </div>
                {% for item in group.list | sort(attribute='name') %}
                <div
                    class="bar-row grid grid-cols-[minmax(0,1fr)] sm:grid-cols-[minmax(0,1fr)_minmax(0,1fr)_auto] items-center gap-3 px-4 py-3 text-sm transition-colors hover:bg-logo/10"
                    data-name="{{ item['name'] }}"
                    data-category="{{ item['category'] or '' }}"
                    data-subcategory="{{ item['sub_category'] or '' }}"
                    data-type="{{ item['type'] }}"
                >
                    <div class="font-medium text-text-normal">{{ item['name'] }}</div>
                    <div class="hidden sm:block text-text-muted">{{ item['sub_category'] or '—' }}</div>
                    <div class="flex items-center justify-between sm:justify-end gap-3">
                        <span class="sm:hidden text-xs text-text-muted">{{ item['category'] or 'Uncategorized' }}{% if item['sub_category'] %} • {{ item['sub_category'] }}{% endif %}</span>
                        <button 
                            class="delete-item inline-flex items-center gap-2 rounded-full border border-border px-3 py-1 text-xs text-text-muted hover:bg-background-light transition"
                            data-name="{{ item['name'] }}"
                            title="Delete">
                            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 16 16" fill="currentColor" class="size-4">
                                <path fill-rule="evenodd" d="M8 15A7 7 0 1 0 8 1a7 7 0 0 0 0 14Zm2.78-4.22a.75.75 0 0 1-1.06 0L8 9.06l-1.72 1.72a.75.75 0 1 1-1.06-1.06L6.94 8 5.22 6.28a.75.75 0 0 1 1.06-1.06L8 6.94l1.72-1.72a.75.75 0 1 1 1.06 1.06L9.06 8l1.72 1.72a.75.75 0 0 1 0 1.06Z" clip-rule="evenodd" />
                            </svg>
                            <span class="sm:hidden">Delete</span>
                        </button>
                    </div>
                </div>
                {% endfor %}
            </div>
        </section>
        {% endfor %}
    </div>
    <p id="bar-no-results" class="hidden py-6 text-center text-text-muted">No items match your current filters.</p>
    {% else %}
        <p class="py-6 text-center text-text-muted">You have not added anything to your bar yet. Use the + button above to get started.</p>
    {% endif %}
    </div>
    
    <!-- Add Item Modal -->
    <div id="add-modal" class="hidden fixed inset-0 bg-black/60 z-40 items-center justify-center px-4 transition-opacity duration-200">
        <div class="modal-box relative w-full max-w-lg transform scale-95 opacity-0 transition-all duration-200 rounded-2xl border border-border bg-background-mid text-text-normal shadow-2xl">
            <button onclick="closeAddModal()" class="absolute top-3 right-3 text-text-muted hover:text-logo transition-colors" aria-label="Close">
                &times;
            </button>
            <h2 class="text-xl font-semibold mb-4">Add to Bar</h2>
            <form method="post" class="space-y-4" onsubmit="return submitWithFields(event)">
                <div class="space-y-2">
                    <label for="name-input" class="block text-xs font-semibold uppercase tracking-wide text-text-muted">Ingredient</label>
                    <div class="relative">
                        <input
                            type="text"
                            id="name-input"
                            placeholder="Start typing to filter..."
                            onkeyup="filterDropdown()"
                            required
                            class="w-full rounded-lg border border-border bg-background-light text-text-normal px-3 py-2 focus:outline-none focus:ring-2 focus:ring-logo placeholder:text-text-muted transition"
                        >
                        <select id="name" name="name" class="hidden" required onchange="updateFields()">
                            <option value="">Select an ingredient</option>
                            {% for name in possible_names %}
                                <option value="{{ name }}">{{ name }}</option>
                            {% endfor %}
                        </select>
                        <div
                            id="name-dropdown"
                            class="absolute left-0 right-0 mt-1 hidden border border-border bg-background-light text-text-normal rounded-lg shadow-xl max-h-48 overflow-y-auto z-20"
                            role="listbox"
                        ></div>
                    </div>
                </div>

                <input type="hidden" id="category" name="category" required>
                <input type="hidden" id="sub_category" name="sub_category">

                <div class="flex flex-wrap items-center justify-between gap-3">
                    <button type="button" id="new-ingredient-trigger" class="hidden items-center gap-2 rounded-full border border-border px-4 py-2 text-text-normal hover:bg-background-light transition" title="Add new ingredient to master list" onclick="openNewIngredientModal()">
                        <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="size-5">
                            <path stroke-linecap="round" stroke-linejoin="round" d="M12 4.5v15m7.5-7.5h-15" />
                        </svg>
                        Add New Ingredient
                    </button>

                    <div class="flex items-center gap-3">
                        <button type="button" onclick="clearIngredientFields()" class="flex items-center gap-2 rounded-full border border-border bg-transparent px-4 py-2 text-text-normal hover:bg-background-light transition" title="Clear current selection">
                            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor" class="size-5">
                                <path fill-rule="evenodd" d="M16.5 4.478v.227a48.816 48.816 0 0 1 3.878.512.75.75 0 1 1-.256 1.478l-.209-.035-1.005 13.07a3 3 0 0 1-2.991 2.77H8.084a3 3 0 0 1-2.991-2.77L4.087 6.66l-.209.035a.75.75 0 0 1-.256-1.478A48.567 48.567 0 0 1 7.5 4.705v-.227c0-1.564 1.213-2.9 2.816-2.951a52.662 52.662 0 0 1 3.369 0c1.603.051 2.815 1.387 2.815 2.951Zm-6.136-1.452a51.196 51.196 0 0 1 3.273 0C14.39 3.05 15 3.684 15 4.478v.113a49.488 49.488 0 0 0-6 0v-.113c0-.794.609-1.428 1.364-1.452Zm-.355 5.945a.75.75 0 1 0-1.5.058l.347 9a.75.75 0 1 0 1.499-.058l-.346-9Zm5.48.058a.75.75 0 1 0-1.498-.058l-.347 9a.75.75 0 0 0 1.5.058l.345-9Z" clip-rule="evenodd" />
                            </svg>
                            Clear
                        </button>

                        <button type="submit" class="flex items-center gap-2 rounded-full bg-logo px-4 py-2 text-light-text-normal hover:ring-2 hover:ring-logo transition" title="Add Bar Item">
                            <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="size-5">
                                <path stroke-linecap="round" stroke-linejoin="round" d="M12 9v6m3-3H9m12 0a9 9 0 1 1-18 0 9 9 0 0 1 18 0Z" />
                            </svg>
                            Add
                        </button>
                    </div>
                </div>
            </form>
        </div>
    </div>

    <!-- Delete Confirmation Modal -->
    <div id="delete-modal" class="fixed inset-0 hidden items-center justify-center bg-black/60 z-50 px-4">
        <div class="w-full max-w-sm rounded-2xl border border-border bg-background-mid text-text-normal shadow-2xl p-6 text-center space-y-4">
            <h3 class="text-xl font-semibold">Confirm Deletion</h3>
            <p id="delete-modal-message" class="text-text-muted"></p>
            <div class="flex items-center justify-center gap-3">
                <button id="confirm-delete" class="rounded-full bg-red-600 px-4 py-2 text-white hover:bg-red-500 transition">Confirm</button>
                <button id="cancel-delete" class="rounded-full border border-border px-4 py-2 text-text-normal hover:bg-background-light transition">Cancel</button>
            </div>
        </div>
    </div>
    
    <!-- New Ingredient Modal -->
    <div id="new-ingredient-modal" data-subcategories='{{ lists["subcategories"] | tojson }}' class="hidden fixed inset-0 bg-black/60 z-50 items-center justify-center px-4 transition-opacity duration-200">
        <div class="modal-box relative w-full max-w-lg transform scale-95 opacity-0 transition-all duration-200 rounded-2xl border border-border bg-background-mid text-text-normal shadow-2xl">
            <button onclick="closeNewIngredientModal()" class="absolute top-3 right-3 text-text-muted hover:text-logo transition-colors" aria-label="Close">
                &times;
            </button>
            <h2 class="text-xl font-semibold mb-4">Add New Ingredient</h2>
            <form id="new-ingredient-form" class="space-y-4">
                <div class="space-y-2">
                    <label for="new-ingredient-name" class="block text-xs font-semibold uppercase tracking-wide text-text-muted">Name</label>
                    <input
                        type="text"
                        id="new-ingredient-name"
                        required
                        class="w-full rounded-lg border border-border bg-background-light text-text-normal px-3 py-2 focus:outline-none focus:ring-2 focus:ring-logo placeholder:text-text-muted transition"
                    />
                </div>
                <div class="space-y-2">
                    <label for="new-ingredient-category" class="block text-xs font-semibold uppercase tracking-wide text-text-muted">Category</label>
                    <select
                        id="new-ingredient-category"
                        required
                        class="w-full rounded-lg border border-border bg-background-light text-text-normal px-3 py-2 focus:outline-none focus:ring-2 focus:ring-logo transition"
                    >
                        <option value="">Select a category</option>
                        {% for category in lists['categories'] %}
                            <option value="{{ category }}">{{ category }}</option>
                        {% endfor %}
                    </select>
                </div>
                <div class="space-y-2 hidden" id="new-subcategory-wrapper">
                    <label for="new-ingredient-subcategory" class="block text-xs font-semibold uppercase tracking-wide text-text-muted">Subcategory (optional)</label>
                    <select
                        id="new-ingredient-subcategory"
                        class="w-full rounded-lg border border-border bg-background-light text-text-normal px-3 py-2 focus:outline-none focus:ring-2 focus:ring-logo transition"
                    >
                        <option value="">Select a subcategory</option>
                    </select>
                </div>
                <div class="flex justify-end gap-3 pt-2">
                    <button type="button" onclick="closeNewIngredientModal()" class="rounded-full border border-border px-4 py-2 text-text-normal hover:bg-background-light transition">
                        Cancel
                    </button>
                    <button type="submit" class="rounded-full bg-logo px-4 py-2 text-light-text-normal hover:ring-2 hover:ring-logo transition">
                        Save Ingredient
                    </button>
                </div>
            </form>
        </div>
    </div>

{% endblock %}

{% block scripts %}
    {{ super() }}
    <script src="{{ url_for('static', filename='js/bar.js') }}" defer></script>
{% endblock %}
