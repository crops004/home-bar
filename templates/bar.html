{% extends "base.html" %}
{% block title %}Bar Contents{% endblock %}
{% block content %}
    
    {% with messages = get_flashed_messages() %}
    {% if messages %}
    <script>
        document.addEventListener('DOMContentLoaded', function() {
            showToast("{{ messages[0] | escape }}");
        });
    </script>
    {% endif %}
    {% endwith %}

    <!-- Add Item and Filter Buttons -->
    <div class="sticky top-[90px] z-50 bg-background-dark  shadow-md p-4">
        <div class="flex justify-between items-center px-4 py-2 pb-6 border-b border-border-muted mb-6">
            <h2 class="bg-background-mid border border-border rounded-full shadow-2xl px-4 py-2 ml-4 text-sm font-medium text-text-normal">Bar Contents</h2>
            <div class="sticky top-18 z-40 flex justify-end pr-4 gap-2" id="action-buttons">
                <!-- Add Item Button -->
                <button onclick="openAddModal()"
                        class="group bg-background-mid border border-border p-2 rounded-full shadow hover:scale-105 transition-transform"
                        title="Add Item">
                    <svg xmlns="http://www.w3.org/2000/svg"
                        fill="none"
                        viewBox="0 0 24 24"
                        stroke-width="1.5"
                        stroke="currentColor"
                        class="w-5 h-5 stroke-text-muted group-hover:stroke-logo transition-colors">
                            <path stroke-linecap="round" stroke-linejoin="round"
                                d="M12 9v6m3-3H9m12 0a9 9 0 1 1-18 0 9 9 0 0 1 18 0Z" />
                    </svg>
                </button>

                <!-- Filter Button -->
                <button onclick="openFilterModal()" 
                        class="group bg-background-mid border border-border p-2 rounded-full shadow hover:scale-105 transition-transform" 
                        title="Filter Items">
                    <svg xmlns="http://www.w3.org/2000/svg" 
                        viewBox="0 0 24 24" 
                        fill="currentColor" 
                        class="w-5 h-5 text-text-muted group-hover:text-logo transition-colors">
                            <path fill-rule="evenodd" d="M3.792 2.938A49.069 49.069 0 0 1 12 2.25c2.797 0 5.54.236 8.209.688a1.857 1.857 0 0 1 1.541 1.836v1.044a3 3 0 0 1-.879 2.121l-6.182 6.182a1.5 1.5 0 0 0-.439 1.061v2.927a3 
                                3 0 0 1-1.658 2.684l-1.757.878A.75.75 0 0 1 9.75 21v-5.818a1.5 1.5 0 0 0-.44-1.06L3.13 7.938a3 3 0 0 1-.879-2.121V4.774c0-.897.64-1.683 1.542-1.836Z" clip-rule="evenodd" />
                    </svg>
                </button>

                <!-- Clear Filter Button -->
                <button id="clear-filter-btn" onclick="clearFilter()" class="hidden bg-yellow-900 p-2 rounded-full shadow hover:bg-yellow-950 hover:scale-105 transition-transform" title="Clear Filter">
                    <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-5 h-5 stroke-white">
                        <path stroke-linecap="round" stroke-linejoin="round" d="M6 18 18 6M6 6l12 12" />
                    </svg>
                </button>
            </div>
        </div>


        <!-- Filter Buttons -->
        <div class="flex flex-wrap items-center gap-2 px-2">
            <button class="filter-btn" data-filter="all">All</button>
            <button class="filter-btn" data-filter="spirit">Spirits</button>
            <button class="filter-btn" data-filter="modifier">Modifiers & Mixers</button>
            <button class="filter-btn" data-filter="gin">Gin</button>
            <button class="filter-btn" data-filter="whiskey">Whiskey</button>
            <button class="filter-btn" data-filter="rum">Rum</button>
            <button class="filter-btn" data-filter="tequila">Tequila</button>
        </div>
    </div>

    <!-- Combined Table -->
    <!-- Simulated Sticky Header -->
    <div class="sticky top-[241px] z-40 bg-background-dark px-4 font-semibold text-[.65rem] sm:text-xs">
        <div class="grid grid-cols-4 w-full text-text-muted uppercase border-b border-border-muted">
            <div class="px-2 py-2 cursor-default" data-col="0" onclick="sortTable('bar-items-table', 0, this)">Name</div>
            <div class="px-2 py-2 cursor-default" data-col="1" onclick="sortTable('bar-items-table', 1, this)">Category</div>
            <div class="px-2 py-2 cursor-default" data-col="2" onclick="sortTable('bar-items-table', 2, this)">Sub Category</div>
            <div class="px-2 py-2 text-right"></div>
        </div>
    </div>
    {% if items %}
    <!-- Full Table -->
    <div class="overflow-x-auto rounded shadow-md mb-4 px-4">
        <table id="bar-items-table" class="w-full table-fixed bg-background-dark text-left text-[.65rem] sm:text-xs">
            <tbody>
                {% for item in items %}
                    <tr class="hover:bg-background-mid border-b border-border-muted bar-row"
                        data-category="{{ item['category'] }}"
                        data-subcategory="{{ item['sub_category'] }}"
                        data-type="{{ item['type'] }}">
                        <td class="px-2 py-2">{{ item['name'] }}</td>
                        <td class="px-2 py-2">{{ item['category'] }}</td>
                        <td class="px-2 py-2">{{ item['sub_category'] or '' }}</td>
                        <td class="px-2 py-2 text-right">
                            <button 
                                class="delete-item text-red-500 hover:text-red-700"
                                data-name="{{ item['name'] }}"
                                title="Delete">
                                <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 16 16" fill="currentColor" class="size-3.5">
                                    <path fill-rule="evenodd" d="M8 15A7 7 0 1 0 8 1a7 7 0 0 0 0 14Zm2.78-4.22a.75.75 0 0 1-1.06 0L8 9.06l-1.72 1.72a.75.75 0 1 1-1.06-1.06L6.94 8 5.22 6.28a.75.75 0 0 1 
                                            1.06-1.06L8 6.94l1.72-1.72a.75.75 0 1 1 1.06 1.06L9.06 8l1.72 1.72a.75.75 0 0 1 0 1.06Z" clip-rule="evenodd" />
                                </svg>
                            </button>
                        </td>
                    </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>
    {% else %}
        <p>No matching items in your bar.</p>
    {% endif %}
    
    <!-- Add Item Modal -->
    <div id="add-modal" class="hidden fixed inset-0 bg-black bg-opacity-40 z-40 transition-opacity duration-200">
        <div class="modal-box bg-white p-6 rounded shadow-lg w-[90%] max-w-md relative transform scale-95 opacity-0 transition-all duration-200">
            <button onclick="closeAddModal()" class="absolute top-2 right-2 text-gray-400 hover:text-gray-600">&times;</button>
            <h2 class="text-lg font-semibold mb-2">Add to Bar</h2>
            <form method="post" onsubmit="return submitWithFields(event)">
                <label for="name">Name: </label>
                <input type="text" id="name-input" placeholder=" Start typing to filter..." onkeyup="filterDropdown()" required>
                <select id="name" name="name" style="display: none;" required onchange="updateFields()">
                    <option value="">Select an ingredient</option>
                    {% for name in possible_names %}
                        <option value="{{ name }}">{{ name }}</option>
                    {% endfor %}
                </select>
                <div id="name-dropdown" style="display: none; border: 1px solid #ccc; max-height: 150px; overflow-y: auto;"></div>

                <!-- Hidden inputs -->
                <input type="hidden" id="category" name="category" required>
                <input type="hidden" id="sub_category" name="sub_category">

                <button type="button" onclick="clearIngredientFields()" class="bg-yellow-900 p-2 rounded-full shadow hover:bg-yellow-950 hover:scale-105 transition-transform text-white" title="Clear">
                    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor" class="size-5">
                        <path fill-rule="evenodd" d="M16.5 4.478v.227a48.816 48.816 0 0 1 3.878.512.75.75 0 1 1-.256 1.478l-.209-.035-1.005 13.07a3 3 0 0 1-2.991 2.77H8.084a3 3 0 0 1-2.991-2.77L4.087 6.66l-.209.035a.75.75 0 0 
                                1-.256-1.478A48.567 48.567 0 0 1 7.5 4.705v-.227c0-1.564 1.213-2.9 2.816-2.951a52.662 52.662 0 0 1 3.369 0c1.603.051 2.815 1.387 2.815 2.951Zm-6.136-1.452a51.196 51.196 0 0 1 3.273 0C14.39 3.05 15 3.684 
                                15 4.478v.113a49.488 49.488 0 0 0-6 0v-.113c0-.794.609-1.428 1.364-1.452Zm-.355 5.945a.75.75 0 1 0-1.5.058l.347 9a.75.75 0 1 0 1.499-.058l-.346-9Zm5.48.058a.75.75 0 1 0-1.498-.058l-.347 9a.75.75 0 0 0 
                                1.5.058l.345-9Z" clip-rule="evenodd" />
                    </svg>
                </button>

                <button type="submit" class="bg-yellow-900 p-2 rounded-full shadow hover:bg-yellow-950 hover:scale-105 transition-transform" title="Add Bar Item">
                    <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-5 h-5 stroke-white">
                        <path stroke-linecap="round" stroke-linejoin="round" d="M12 9v6m3-3H9m12 0a9 9 0 1 1-18 0 9 9 0 0 1 18 0Z" />
                    </svg>
                </button>
            </form>
        </div>
    </div>

    <!-- Delete Confirmation Modal -->
    <div id="delete-modal" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 1000;">
        <div style="position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); background: white; padding: 20px; border-radius: 5px; box-shadow: 0 2px 10px rgba(0,0,0,0.1);">
            <h3>Confirm Deletion</h3>
            <p id="delete-modal-message"></p>
            <button id="confirm-delete" style="background-color: #ff4444; color: white; border: none; padding: 5px 10px; border-radius: 4px; cursor: pointer; margin-right: 10px;">Confirm</button>
            <button id="cancel-delete" style="background-color: #ccc; color: black; border: none; padding: 5px 10px; border-radius: 4px; cursor: pointer;">Cancel</button>
        </div>
    </div>
    
    <!-- Filter Modal -->
    <div id="filter-modal" class="hidden fixed inset-0 bg-black bg-opacity-40 items-center justify-center z-50 transition-opacity duration-200">
        <div class="absolute top-20 right-4 left-4 sm:left-auto sm:right-6 sm:w-[20rem] bg-white p-4 rounded shadow-md transition-all duration-200 modal-box opacity-0 translate-y-[-0.5rem]">
            <button onclick="closeFilterModal()" class="absolute top-2 right-2 text-gray-400 hover:text-gray-600">&times;</button>
            <h2 class="text-lg font-semibold mb-2">Filter All Items</h2>
            <input type="text" id="filter-all" placeholder="Filter by name, category, or subcategory..."
                onkeyup="filterAllTables()"
                class="w-full border px-3 py-2 rounded" />
        </div>
    </div>

    <script>
        // Open Add Modal and focus the first input
        function openAddModal() {
            const modal = document.getElementById('add-modal');
            const box = modal.querySelector('.modal-box');
            modal.classList.remove('hidden');

            // Animate in
            requestAnimationFrame(() => {
                box.classList.remove('opacity-0', 'scale-95');
                box.classList.add('opacity-100', 'scale-100');
            });

            setTimeout(() => {
                document.getElementById('name-input').focus();
            }, 10);
        }

        // Open Filter Modal and focus the input
        function openFilterModal() {
            const modal = document.getElementById('filter-modal');
            const box = modal.querySelector('.modal-box');
            modal.classList.remove('hidden');

            // Force reflow to enable transition
            void box.offsetWidth;

            box.classList.remove('opacity-0', 'translate-y-[-0.5rem]');
            box.classList.add('opacity-100', 'translate-y-0');

            setTimeout(() => {
                document.getElementById('filter-all').focus();
            }, 10);
        }

        function closeAddModal() {
            const modal = document.getElementById('add-modal');
            const box = modal.querySelector('.modal-box');

            box.classList.remove('opacity-100', 'scale-100');
            box.classList.add('opacity-0', 'scale-95');

            setTimeout(() => {
                modal.classList.add('hidden');
            }, 200); // Match transition duration
        }

        function closeFilterModal() {
            const modal = document.getElementById('filter-modal');
            const box = modal.querySelector('.modal-box');

            box.classList.remove('opacity-100', 'scale-100');
            box.classList.add('opacity-0', 'scale-95');

            setTimeout(() => {
                modal.classList.add('hidden');
            }, 200);
        }

        // Close modals on Escape key
        document.addEventListener('keydown', function(event) {
            if (event.key === 'Escape') {
                closeAddModal();
                closeFilterModal();
            }
        });

        // Close modal when clicking outside modal box
        document.addEventListener('click', function(event) {
            const addModal = document.getElementById('add-modal');
            const filterModal = document.getElementById('filter-modal');

            if (addModal && !addModal.classList.contains('hidden') && event.target === addModal) {
                closeAddModal();
            }

            if (filterModal && !filterModal.classList.contains('hidden') && event.target === filterModal) {
                closeFilterModal();
            }
        });

        function clearFilter() {
            const input = document.getElementById('filter-all');
            input.value = '';
            filterAllTables(); // triggers reset logic
            document.getElementById('clear-filter-btn').classList.add('hidden');
        }

        // Submit form with ingredient details
        async function submitWithFields(event) {
            event.preventDefault(); // stop form from submitting right away

            const name = document.getElementById('name').value;
            const categoryInput = document.getElementById('category');
            const subCategoryInput = document.getElementById('sub_category');

            // Clear previous values
            categoryInput.value = '';
            subCategoryInput.value = '';

            if (name) {
                try {
                    const response = await fetch(`/ingredient-details/${encodeURIComponent(name)}`);
                    const data = await response.json();

                    if (data.error) {
                        alert(data.error);
                        return;
                    }

                    if (data.category) categoryInput.value = data.category;
                    if (data.sub_category) subCategoryInput.value = data.sub_category;

                    event.target.submit(); // ✅ now that everything is filled in, submit the form

                } catch (err) {
                    console.error("Error fetching ingredient details:", err);
                    alert("There was a problem adding the item.");
                }
            } else {
                alert("Please select a valid item.");
            }
        }

        document.addEventListener('DOMContentLoaded', function() {
            let itemToDelete = null;

            // Handle delete button clicks
            const deleteButtons = document.querySelectorAll('.delete-item');
            deleteButtons.forEach(button => {
                button.addEventListener('click', function() {
                    itemToDelete = this.getAttribute('data-name');
                    const modal = document.getElementById('delete-modal');
                    const message = document.getElementById('delete-modal-message');
                    message.textContent = `Are you sure you want to delete ${itemToDelete} from your bar?`;
                    modal.style.display = 'block';
                });
            });

            // Confirm deletion
            document.getElementById('confirm-delete').addEventListener('click', function() {
                if (itemToDelete) {
                    fetch(`/bar/delete_bar_item/${itemToDelete}`, {
                        method: 'DELETE'
                    })
                    .then(response => response.json())
                    .then(data => {
                        // Close the modal and refresh the page
                        document.getElementById('delete-modal').style.display = 'none';
                        location.reload();
                    })
                    .catch(error => {
                        console.error('Error deleting item:', error);
                        alert('Error deleting item.');
                        document.getElementById('delete-modal').style.display = 'none';
                    });
                }
            });

            // Cancel deletion
            document.getElementById('cancel-delete').addEventListener('click', function() {
                document.getElementById('delete-modal').style.display = 'none';
                itemToDelete = null;
            });

            // Filter dropdown as user types
            window.filterDropdown = function() {
                const inputEl = document.getElementById('name-input');
                const input = inputEl.value.toLowerCase();
                const select = document.getElementById('name');
                const dropdown = document.getElementById('name-dropdown');
                const categoryFields = document.getElementById('category-fields');

                dropdown.innerHTML = '';

                if (input === '') {
                    dropdown.style.display = 'none';
                    select.value = '';
                    // Clear and hide category fields
                    document.getElementById('category').value = '';
                    document.getElementById('sub_category').value = '';
                    categoryFields.style.display = 'none';
                    return;
                }

                dropdown.style.display = 'block';
                const options = Array.from(select.options).slice(1); // Skip the "Select an ingredient" option
                const filteredOptions = options.filter(option => option.value.toLowerCase().includes(input));

                if (filteredOptions.length > 0) {
                    filteredOptions.forEach(option => {
                        const div = document.createElement('div');
                        div.textContent = option.value;
                        div.style.padding = '5px';
                        div.style.cursor = 'pointer';
                        div.addEventListener('click', function() {
                            document.getElementById('name-input').value = option.value;
                            select.value = option.value;
                            dropdown.style.display = 'none';
                            updateFields();  // fill category/subcategory + show fields if needed
                        });
                        dropdown.appendChild(div);
                    });
                } else {
                    dropdown.style.display = 'none';
                }
            };
            
            // Clear ingredient fields
            window.clearIngredientFields = function() {
                document.getElementById('name-input').value = '';
                document.getElementById('name').value = '';
                document.getElementById('category').value = '';
                document.getElementById('sub_category').value = '';
                document.getElementById('category-fields').style.display = 'none';
                document.getElementById('name-dropdown').style.display = 'none';
            };

            // Autofill category and sub_category fields
            window.updateFields = function () {
                const name = document.getElementById('name').value;
                const categoryInput = document.getElementById('category');
                const subCategoryInput = document.getElementById('sub_category');
                const categoryFields = document.getElementById('category-fields');

                // Always reset
                categoryFields.style.display = 'none';
                categoryInput.value = '';
                subCategoryInput.value = '';
                categoryInput.parentElement.style.display = 'none';
                subCategoryInput.parentElement.style.display = 'none';

                if (name) {
                    fetch(`/ingredient-details/${encodeURIComponent(name)}`)
                        .then(response => response.json())
                        .then(data => {
                            if (data.error) {
                                alert(data.error);
                            } else {
                                const hasCategory = !!data.category;
                                const hasSubCategory = !!data.sub_category;

                                if (hasCategory || hasSubCategory) {
                                    categoryFields.style.display = 'block';
                                }

                                if (hasCategory) {
                                    categoryInput.value = data.category;
                                    categoryInput.parentElement.style.display = 'inline-block';
                                }

                                if (hasSubCategory) {
                                    subCategoryInput.value = data.sub_category;
                                    subCategoryInput.parentElement.style.display = 'inline-block';
                                }
                            }
                        })
                        .catch(error => {
                            console.error('Error fetching ingredient details:', error);
                        });
                }
            };

            // Hide dropdown when clicking outside
            document.addEventListener('click', function(event) {
                const dropdown = document.getElementById('name-dropdown');
                const input = document.getElementById('name-input');
                if (!input.contains(event.target) && !dropdown.contains(event.target)) {
                    dropdown.style.display = 'none';
                }
            });

            // Sorting function
            window.sortTable = function(tableId, colIndex, headerDiv) {
                const table = document.getElementById(tableId);
                const tbody = table.querySelector('tbody');
                const rows = Array.from(tbody.querySelectorAll('tr'));
                
                // Determine direction from data attribute
                const current = headerDiv.getAttribute('data-sort') || 'none';
                const newDirection = current === 'asc' ? 'desc' : 'asc';
                
                // Clear sort state from all header divs
                const headers = headerDiv.parentElement.querySelectorAll('div[data-col]');
                headers.forEach(h => h.removeAttribute('data-sort'));

                // Set the new direction on the clicked header
                headerDiv.setAttribute('data-sort', newDirection);

                rows.sort((a, b) => {
                    const cellA = a.children[colIndex].textContent.trim().toLowerCase();
                    const cellB = b.children[colIndex].textContent.trim().toLowerCase();
                    return newDirection === 'asc'
                        ? cellA.localeCompare(cellB)
                        : cellB.localeCompare(cellA);
                });

                rows.forEach(row => tbody.appendChild(row));
            };

            // Attach click listener to all filter buttons
            document.querySelectorAll('.filter-btn').forEach(button => {
                button.addEventListener('click', () => {
                    const filter = button.dataset.filter;
                    filterTable(filter);
                });
            });

            // Filter table rows based on the selected filter
            window.filterTable = function(filter) {
                const rows = document.querySelectorAll('.bar-row');
                const normalizedFilter = filter.toLowerCase();

                // Highlight active button
                const buttons = document.querySelectorAll('.filter-btn');
                buttons.forEach(btn => btn.classList.remove('bg-background-mid', 'text-logo'));
                const active = Array.from(buttons).find(btn => btn.dataset.filter === normalizedFilter);
                if (active) {
                    active.classList.add('bg-background-mid', 'text-logo');
                }

                rows.forEach(row => {
                    const category = (row.dataset.category || '').toLowerCase();
                    const subcategory = (row.dataset.subcategory || '').toLowerCase();
                    const type = (row.dataset.type || '');

                    let match = false;

                    if (normalizedFilter === 'all') {
                        match = true;
                    } else if (normalizedFilter === 'spirit') {
                        match = type === 'spirit';
                    } else if (normalizedFilter === 'modifier') {
                        match = type === 'modifier';
                    } else {
                        match = category === normalizedFilter || subcategory === normalizedFilter;
                    }

                    row.style.display = match ? '' : 'none';
                });
            };

            window.filterAllTables = function() {
                const filterValue = document.getElementById('filter-all').value.toLowerCase();
                const clearButton = document.getElementById('clear-filter-btn');

                // Show or hide clear button
                if (filterValue.trim() !== '') {
                    clearButton.classList.remove('hidden');
                } else {
                    clearButton.classList.add('hidden');
                }

                const tables = ['other-items-table', 'spirits-table'];

                tables.forEach(tableId => {
                    const table = document.getElementById(tableId);
                    const noItemsDivId = tableId === 'other-items-table' ? 'misc-no-items' : 'spirits-no-items';
                    const noItemsDiv = document.getElementById(noItemsDivId);

                    if (!table) return;

                    const tbody = table.getElementsByTagName('tbody')[0];
                    const rows = tbody.getElementsByTagName('tr');
                    let hasVisibleRows = false;

                    for (let i = 0; i < rows.length; i++) {
                        const name = rows[i].cells[0].textContent.toLowerCase();
                        const category = rows[i].cells[1].textContent.toLowerCase();
                        const subcategory = rows[i].cells[2].textContent.toLowerCase();

                        const matches = name.includes(filterValue) ||
                                        category.includes(filterValue) ||
                                        subcategory.includes(filterValue);

                        if (matches) {
                            rows[i].style.display = '';
                            hasVisibleRows = true;
                        } else {
                            rows[i].style.display = 'none';
                        }
                    }

                    if (noItemsDiv) {
                        noItemsDiv.style.display = (rows.length > 0 && !hasVisibleRows) ? 'block' : 'none';
                    }
                });
            };

            // Initial call to filterAllTables to handle any pre-filled filter values
            filterAllTables();
        });
    </script>
{% endblock %}