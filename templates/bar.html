{% extends "base.html" %}
{% block title %}Bar Contents{% endblock %}
{% block content %}
    
    {% with messages = get_flashed_messages() %}
    {% if messages %}
        <div class="hidden" data-toast-message="{{ messages[0] | escape }}" aria-hidden="true"></div>
    {% endif %}
    {% endwith %}

    <div class="px-4 sm:px-6 pt-0 pb-28 sm:pb-10">
        <div class="sticky top-0 sm:top-[var(--desktop-nav-offset)] z-30 bg-background-dark/95 supports-[backdrop-filter]:bg-background-dark/80 backdrop-blur pt-4 sm:pt-0 pb-4 space-y-6">
            <div class="flex flex-col sm:flex-row sm:items-center sm:justify-between gap-4">
                <h1 class="text-3xl font-semibold text-text-normal">Bar Contents</h1>
                <div class="flex flex-wrap items-center gap-2">
                    <button
                        type="button"
                        onclick="openAddModal()"
                        class="inline-flex h-11 w-48 items-center justify-center gap-2 rounded-full bg-logo px-5 py-2 text-sm font-medium text-light-text-normal hover:ring-2 hover:ring-logo transition"
                        title="Add Item"
                    >
                        <span class="text-xl leading-none">+</span>
                        Add Item
                    </button>
                </div>
            </div>
            <div class="rounded-2xl border border-border bg-background-mid p-4 sm:p-5">
                <div class="flex items-start justify-between gap-3">
                    <div>
                        <h2 class="text-lg font-semibold text-text-normal">Filters</h2>
                        <p class="text-sm text-text-muted">Use + to expand filter controls.</p>
                    </div>
                    <button
                        id="bar-filters-toggle"
                        type="button"
                        class="inline-flex h-9 w-9 items-center justify-center rounded-full border border-border text-text-normal hover:bg-background-light transition"
                        aria-expanded="false"
                        aria-controls="bar-filters-panel"
                        title="Toggle filters"
                    >
                        <svg id="bar-filters-plus" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor" class="size-5">
                            <path d="M10 4.75a.75.75 0 0 1 .75.75v3.75h3.75a.75.75 0 0 1 0 1.5h-3.75v3.75a.75.75 0 0 1-1.5 0v-3.75H5.5a.75.75 0 0 1 0-1.5h3.75V5.5a.75.75 0 0 1 .75-.75Z" />
                        </svg>
                        <svg id="bar-filters-minus" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor" class="size-5 hidden">
                            <path d="M5.75 10a.75.75 0 0 1 .75-.75h7a.75.75 0 0 1 0 1.5h-7a.75.75 0 0 1-.75-.75Z" />
                        </svg>
                        <span class="sr-only">Toggle bar filters</span>
                    </button>
                </div>
                <div id="bar-filters-panel" class="hidden mt-4">
                    <div class="flex flex-wrap items-center gap-3 rounded-2xl border border-border bg-background-mid/40 p-4">
                        <div class="flex flex-wrap items-center gap-2">
                            <span class="text-xs uppercase tracking-wide text-text-muted">Category</span>
                            <button class="filter-btn" data-filter="all">All</button>
                            <button class="filter-btn" data-filter="spirit">Spirits</button>
                            <button class="filter-btn" data-filter="modifier">Modifiers & Mixers</button>
                            <button class="filter-btn" data-filter="gin">Gin</button>
                            <button class="filter-btn" data-filter="whiskey">Whiskey</button>
                            <button class="filter-btn" data-filter="rum">Rum</button>
                            <button class="filter-btn" data-filter="tequila">Tequila</button>
                        </div>
                        <div class="w-full sm:w-auto sm:ml-auto">
                            <div class="relative w-full sm:w-60">
                                <input
                                    type="text"
                                    id="filter-all"
                                    placeholder="Filter..."
                                    oninput="filterAllTables()"
                                    class="modal-input w-full pr-20"
                                />
                                <button
                                    type="button"
                                    id="clear-filter-btn"
                                    onclick="clearFilter()"
                                    class="absolute right-2 top-1/2 -translate-y-1/2 text-xs font-semibold text-text-normal px-3 py-1 rounded-full border border-logo bg-background-light hover:bg-background-mid transition opacity-0 invisible pointer-events-none"
                                    aria-label="Clear search"
                                    aria-hidden="true"
                                >
                                    Clear
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

    {% if items %}
    {% set grouped_items = items | sort(attribute='category') | groupby('category') %}
    <div id="bar-accordion" class="mt-6 space-y-4">
        {% for group in grouped_items %}
        {% set category = group.grouper or 'Uncategorized' %}
        {% set panel_id = 'bar-section-' ~ loop.index %}
        {% set item_count = group.list | length %}
        <section class="bar-category ui-card" data-category="{{ category }}">
            <button
                type="button"
                class="bar-category-toggle ui-card-header flex w-full items-center justify-between gap-3 px-4 py-3 text-left"
                data-target="{{ panel_id }}"
                aria-expanded="true"
            >
                <div class="flex flex-col">
                    <span class="text-xs uppercase tracking-wide text-text-muted">Category</span>
                    <span class="text-lg font-semibold text-text-normal">{{ category }}</span>
                </div>
                <div class="flex items-center gap-3">
                    <span class="bar-category-count rounded-full bg-background-dark px-3 py-1 text-xs text-text-muted">{{ item_count }} item{% if item_count != 1 %}s{% endif %}</span>
                    <svg class="size-4 text-text-muted transition-transform" data-chevron aria-hidden="true" viewBox="0 0 20 20" fill="currentColor">
                        <path fill-rule="evenodd" d="M5.293 7.293a1 1 0 0 1 1.414 0L10 10.586l3.293-3.293a1 1 0 1 1 1.414 1.414l-4 4a1 1 0 0 1-1.414 0l-4-4a1 1 0 0 1 0-1.414Z" clip-rule="evenodd" />
                    </svg>
                </div>
            </button>
            <div id="{{ panel_id }}" class="bar-category-panel divide-y divide-border bg-background-dark">
                <div class="hidden sm:grid sm:grid-cols-[minmax(0,1fr)_minmax(0,1fr)_auto] gap-3 px-4 py-2 text-xs uppercase tracking-wide text-text-muted">
                    <span>Name</span>
                    <span>Subcategory</span>
                    <span class="text-right">Actions</span>
                </div>
                {% for item in group.list | sort(attribute='name') %}
                <div
                    class="bar-row flex items-center justify-between gap-3 px-4 py-3 text-sm transition-colors hover:bg-logo/10 sm:grid sm:grid-cols-[minmax(0,1fr)_minmax(0,1fr)_auto] sm:items-center"
                    data-name="{{ item['name'] }}"
                    data-category="{{ item['category'] or '' }}"
                    data-subcategory="{{ item['sub_category'] or '' }}"
                    data-type="{{ item['type'] }}"
                >
                    <div class="min-w-0 flex items-baseline gap-2">
                        <span class="truncate font-medium text-text-normal">{{ item['name'] }}</span>
                        {% if item['sub_category'] %}
                        <span class="sm:hidden truncate text-xs text-text-muted">{{ item['sub_category'] }}</span>
                        {% endif %}
                    </div>
                    <div class="hidden sm:block text-text-muted">{{ item['sub_category'] or '-' }}</div>
                    <div class="flex shrink-0 items-center sm:justify-end gap-3">
                        <button 
                            class="delete-item inline-flex items-center rounded-full border border-border p-2 text-xs text-text-muted hover:bg-background-light transition"
                            data-name="{{ item['name'] }}"
                            title="Delete" aria-label="Delete">
                            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 16 16" fill="currentColor" class="size-4">
                                <path fill-rule="evenodd" d="M8 15A7 7 0 1 0 8 1a7 7 0 0 0 0 14Zm2.78-4.22a.75.75 0 0 1-1.06 0L8 9.06l-1.72 1.72a.75.75 0 1 1-1.06-1.06L6.94 8 5.22 6.28a.75.75 0 0 1 1.06-1.06L8 6.94l1.72-1.72a.75.75 0 1 1 1.06 1.06L9.06 8l1.72 1.72a.75.75 0 0 1 0 1.06Z" clip-rule="evenodd" />
                            </svg>
                        </button>
                    </div>
                </div>
                {% endfor %}
            </div>
        </section>
        {% endfor %}
    </div>
    <p id="bar-no-results" class="hidden py-6 text-center text-text-muted">No items match your current filters.</p>
    {% else %}
        <p class="py-6 text-center text-text-muted">You have not added anything to your bar yet. Use the + button above to get started.</p>
    {% endif %}
    </div>
    
    <!-- Add Item Modal -->
    <div id="add-modal" class="hidden fixed inset-0 z-50 items-center justify-center bg-black/70 backdrop-blur-sm p-4">
        <div class="modal-box relative w-full max-w-2xl transform scale-95 opacity-0 transition-all duration-200 rounded-3xl border border-border bg-background-dark text-base text-text-normal shadow-2xl overflow-hidden">
            <div class="flex items-center justify-between border-b border-border bg-background-mid px-6 py-4">
                <h2 class="text-xl font-semibold text-text-normal">Add to Bar</h2>
                <button onclick="closeAddModal()" class="text-2xl leading-none text-text-muted hover:text-logo transition-colors" aria-label="Close">
                    &times;
                </button>
            </div>
            <form method="post" class="flex flex-col" onsubmit="return submitWithFields(event)">
                <div class="space-y-4 bg-background-dark px-6 py-5">
                    <label for="name-input" class="flex flex-col gap-1 text-sm">
                        <span class="modal-label">Ingredient</span>
                        <div class="relative">
                            <input
                                type="text"
                                id="name-input"
                                placeholder="Start typing to filter..."
                                onkeyup="filterDropdown()"
                                required
                                class="modal-input w-full"
                            >
                            <select id="name" name="name" class="hidden" required onchange="updateFields()">
                                <option value="">Select an ingredient</option>
                                {% for name in possible_names %}
                                    <option value="{{ name }}">{{ name }}</option>
                                {% endfor %}
                            </select>
                            <div id="name-dropdown" class="ingredient-dropdown hidden" role="listbox"></div>
                        </div>
                        <span class="text-xs text-text-muted">Can't find it? Use "Add New Ingredient" below.</span>
                    </label>

                    <input type="hidden" id="category" name="category" required>
                    <input type="hidden" id="sub_category" name="sub_category">
                </div>

                <div class="flex flex-wrap items-center justify-between gap-3 border-t border-border bg-background-mid px-6 py-4">
                    <button type="button" id="new-ingredient-trigger" class="hidden items-center gap-2 rounded-full border border-border px-4 py-2 text-sm text-text-normal hover:bg-background-light transition" title="Add new ingredient to master list" onclick="openNewIngredientModal()">
                        <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="size-4">
                            <path stroke-linecap="round" stroke-linejoin="round" d="M12 4.5v15m7.5-7.5h-15" />
                        </svg>
                        Add New Ingredient
                    </button>

                    <div class="ml-auto flex items-center gap-3">
                        <button type="button" onclick="clearIngredientFields()" class="modal-button-secondary" title="Clear current selection">
                            Clear
                        </button>
                        <button type="submit" class="modal-button-primary inline-flex items-center gap-2" title="Add Bar Item">
                            <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="size-4">
                                <path stroke-linecap="round" stroke-linejoin="round" d="M12 9v6m3-3H9m12 0a9 9 0 1 1-18 0 9 9 0 0 1 18 0Z" />
                            </svg>
                            Add
                        </button>
                    </div>
                </div>
            </form>
        </div>
    </div>

    <!-- Delete Confirmation Modal -->
    <div id="delete-modal" class="fixed inset-0 hidden items-center justify-center bg-black/60 z-50 px-4">
        <div class="w-full max-w-sm rounded-2xl border border-border bg-background-mid text-text-normal shadow-2xl p-6 text-center space-y-4">
            <h3 class="text-xl font-semibold">Confirm Deletion</h3>
            <p id="delete-modal-message" class="text-text-muted"></p>
            <div class="flex items-center justify-center gap-3">
                <button id="confirm-delete" class="rounded-full bg-red-600 px-4 py-2 text-white hover:bg-red-500 transition">Confirm</button>
                <button id="cancel-delete" class="rounded-full border border-border px-4 py-2 text-text-normal hover:bg-background-light transition">Cancel</button>
            </div>
        </div>
    </div>
    
    <!-- New Ingredient Modal -->
    <div id="new-ingredient-modal" data-subcategories='{{ lists["subcategories"] | tojson }}' class="hidden fixed inset-0 bg-black/60 z-50 items-center justify-center px-4 transition-opacity duration-200">
        <div class="modal-box relative w-full max-w-lg transform scale-95 opacity-0 transition-all duration-200 rounded-2xl border border-border bg-background-mid text-text-normal shadow-2xl">
            <button onclick="closeNewIngredientModal()" class="absolute top-3 right-3 text-text-muted hover:text-logo transition-colors" aria-label="Close">
                &times;
            </button>
            <h2 class="text-xl font-semibold mb-4">Add New Ingredient</h2>
            <form id="new-ingredient-form" class="space-y-4">
                <div class="space-y-2">
                    <label for="new-ingredient-name" class="block text-xs font-semibold uppercase tracking-wide text-text-muted">Name</label>
                    <input
                        type="text"
                        id="new-ingredient-name"
                        required
                        class="w-full rounded-lg border border-border bg-background-light text-text-normal px-3 py-2 focus:outline-none focus:ring-2 focus:ring-logo placeholder:text-text-muted transition"
                    />
                </div>
                <div class="space-y-2">
                    <label for="new-ingredient-category" class="block text-xs font-semibold uppercase tracking-wide text-text-muted">Category</label>
                    <select
                        id="new-ingredient-category"
                        required
                        class="w-full rounded-lg border border-border bg-background-light text-text-normal px-3 py-2 focus:outline-none focus:ring-2 focus:ring-logo transition"
                    >
                        <option value="">Select a category</option>
                        {% for category in lists['categories'] %}
                            <option value="{{ category }}">{{ category }}</option>
                        {% endfor %}
                    </select>
                </div>
                <div class="space-y-2 hidden" id="new-subcategory-wrapper">
                    <label for="new-ingredient-subcategory" class="block text-xs font-semibold uppercase tracking-wide text-text-muted">Subcategory (optional)</label>
                    <select
                        id="new-ingredient-subcategory"
                        class="w-full rounded-lg border border-border bg-background-light text-text-normal px-3 py-2 focus:outline-none focus:ring-2 focus:ring-logo transition"
                    >
                        <option value="">Select a subcategory</option>
                    </select>
                </div>
                <div class="flex justify-end gap-3 pt-2">
                    <button type="button" onclick="closeNewIngredientModal()" class="rounded-full border border-border px-4 py-2 text-text-normal hover:bg-background-light transition">
                        Cancel
                    </button>
                    <button type="submit" class="rounded-full bg-logo px-4 py-2 text-light-text-normal hover:ring-2 hover:ring-logo transition">
                        Save Ingredient
                    </button>
                </div>
            </form>
        </div>
    </div>

{% endblock %}

{% block scripts %}
    {{ super() }}
    <script src="{{ url_for('static', filename='js/bar.js') }}" defer></script>
{% endblock %}
