{% extends "base.html" %}
{% block title %}Recipe Collection{% endblock %}
{% block content %}
    <h1>Recipe Collection</h1>

    <!-- Button to open the Add Recipe modal -->
    <button onclick="openAddModal()" style="background-color: #4CAF50; color: white; padding: 10px 20px; border: none; border-radius: 4px; cursor: pointer;">Add New Recipe</button>

    <!-- Filter Row for Table -->
    <div style="margin: 20px 0;">
        <h2>Filter Recipes</h2>
        <input type="text" id="filter-name" placeholder="Filter Drink Name..." onkeyup="filterTable()" style="margin-right: 10px; width: 200px;">
        <input type="text" id="filter-spirit" placeholder="Filter Base Spirit..." onkeyup="filterTable()" style="width: 200px;">
    </div>

    <!-- Recipe Table on Left -->
    {% if all_recipes %}
        <table id="recipes-table" border="1" style="border-collapse: collapse; width: 70%; table-layout: fixed; float: left;">
            <thead>
                <tr>
                    <th style="width: 50%;" onclick="sortTable('recipes-table', 0)">Drink Name <span class="sort-arrow"></span></th>
                    <th style="width: 50%;" onclick="sortTable('recipes-table', 1)">Base Spirit <span class="sort-arrow"></span></th>
                </tr>
            </thead>
            <tbody>
                {% for recipe in all_recipes %}
                    <tr onclick="showRecipe(this)" data-drink="{{ recipe.drink }}">
                        <td>{{ recipe.drink }}</td>
                        <td>{{ recipe.base_spirit }}</td>
                    </tr>
                {% endfor %}
            </tbody>
        </table>
    {% else %}
        <p style="width: 70%; float: left;">No recipes yet.</p>
    {% endif %}

    <!-- Sidebar on Right -->
    <div style="width: 30%; float: right; padding: 20px; background-color: #f0f0f0; height: 80vh; overflow-y: auto; box-sizing: border-box; position: relative;">
        <div id="recipe-details" style="display: none;">
            <h3 id="recipe-name"></h3>
            <p><strong>Base Spirit:</strong> <span id="recipe-base-spirit"></span></p>
            <h4>Ingredients:</h4>
            <ul id="recipe-ingredients"></ul>
            <p><strong>Glass:</strong> <span id="recipe-glass"></span></p>
            <p><strong>Garnish:</strong> <span id="recipe-garnish"></span></p>
            <p><strong>Method:</strong> <span id="recipe-method"></span></p>
            <p><strong>Ice:</strong> <span id="recipe ice"></span></p>
            <p><strong>Notes:</strong> <span id="recipe-notes"></span></p>
            <button id="edit-recipe" style="background-color: #2196F3; color: white; border: none; padding: 5px 10px; border-radius: 4px; cursor: pointer; margin-right: 10px;">Edit</button>
            <button id="delete-recipe" style="background-color: #ff4444; color: white; border: none; padding: 5px 10px; border-radius: 4px; cursor: pointer;">Delete</button>
            <button id="clear-sidebar" style="background-color: #888; color: white; border: none; padding: 5px 10px; border-radius: 4px; cursor: pointer; margin-left: 10px;">Clear</button>
        </div>
        <p id="no-recipe-selected" style="display: block;">Click a drink to see its recipe.</p>
    </div>

    <div style="clear: both;"></div>

    <!-- Add Recipe Modal -->
    <div id="add-modal" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background-color: rgba(0,0,0,0.5);">
        <div style="background-color: white; margin: 10% auto; padding: 20px; width: 50%; border-radius: 5px;">
            <h2>Add New Recipe</h2>
            <form id="add-recipe-form" method="post">
                <label for="add-drink">Drink Name:</label>
                <input type="text" id="add-drink" name="drink" required><br><br>

                <label for="add-base_spirit">Base Spirit:</label>
                <input type="text" id="add-base_spirit-input" placeholder="Type to filter base spirits..." onkeyup="filterBaseSpirit('add')">
                <div id="add-base_spirit-dropdown" style="display: none; border: 1px solid #ccc; max-height: 150px; overflow-y: auto;"></div>
                <select id="add-base_spirit" name="base_spirit" style="display: none;">
                    <option value="">None</option>
                    {% for cat in lists['categories'] %}
                        <option value="{{ cat }}">{{ cat }}</option>
                    {% endfor %}
                    {% for cat, subs in lists['subcategories'].items() %}
                        {% for sub in subs %}
                            <option value="{{ sub }}">{{ sub }} ({{ cat }})</option>
                        {% endfor %}
                    {% endfor %}
                </select><br><br>

                <label for="add-glass">Glass:</label>
                <select id="add-glass" name="glass">
                    <option value="">None</option>
                    {% for glass in lists['glass_types'] %}
                        <option value="{{ glass }}">{{ glass }}</option>
                    {% endfor %}
                </select><br><br>

                <label for="add-garnish">Garnish:</label>
                <input type="text" id="add-garnish" name="garnish"><br><br>

                <label for="add-method">Method:</label>
                <select id="add-method" name="method">
                    <option value="">None</option>
                    {% for method in lists['methods'] %}
                        <option value="{{ method }}">{{ method }}</option>
                    {% endfor %}
                </select><br><br>

                <label for="add_ice">Ice:</label>
                <select id="add_ice" name="Ice">
                    <option value="">None</option>
                    {% for ice in lists['ice_options'] %}
                        <option value="{{ ice }}">{{ ice }}</option>
                    {% endfor %}
                </select><br><br>

                <label for="add-notes">Notes:</label>
                <textarea id="add-notes" name="notes"></textarea><br><br>

                <h3>Ingredients</h3>
                <div id="add-ingredients-list">
                    <div class="ingredient-row">
                        <input type="text" name="ingredient_0" class="ingredient-input" placeholder="Type to search ingredients..." onkeyup="filterIngredients(this, 0)">
                        <div class="ingredient-dropdown" style="display: none; border: 1px solid #ccc; max-height: 150px; overflow-y: auto;"></div>
                        <input type="text" name="quantity_0" placeholder="Quantity" style="width: 100px;">
                        <select name="unit_0">
                            {% for unit in lists['units'] %}
                                <option value="{{ unit }}" {% if unit == 'oz' %}selected{% endif %}>{{ unit }}</option>
                            {% endfor %}
                        </select>
                        <button type="button" onclick="removeIngredient(this)" style="background-color: #ff4444; color: white; border: none; border-radius: 4px; cursor: pointer;">Remove</button>
                    </div>
                </div>
                <button type="button" onclick="addIngredient('add')" style="background-color: #2196F3; color: white; padding: 5px 10px; border: none; border-radius: 4px; cursor: pointer;">Add Ingredient</button><br><br>

                <button type="submit" style="background-color: #4CAF50; color: white; padding: 10px 20px; border: none; border-radius: 4px; cursor: pointer;">Save Recipe</button>
                <button type="button" onclick="closeAddModal()" style="background-color: #ff4444; color: white; padding: 10px 20px; border: none; border-radius: 4px; cursor: pointer;">Cancel</button>
            </form>
        </div>
    </div>

    <!-- Edit Recipe Modal -->
    <div id="edit-modal" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background-color: rgba(0,0,0,0.5);">
        <div style="background-color: white; margin: 10% auto; padding: 20px; width: 50%; border-radius: 5px;">
            <h2>Edit Recipe</h2>
            <form id="edit-recipe-form">
                <input type="hidden" id="edit-original-drink" name="original_drink">
                <label for="edit-drink">Drink Name:</label>
                <input type="text" id="edit-drink" name="drink" required><br><br>

                <label for="edit-base_spirit">Base Spirit:</label>
                <input type="text" id="edit-base_spirit-input" placeholder="Type to filter base spirits..." onkeyup="filterBaseSpirit('edit')">
                <div id="edit-base_spirit-dropdown" style="display: none; border: 1px solid #ccc; max-height: 150px; overflow-y: auto;"></div>
                <select id="edit-base_spirit" name="base_spirit" style="display: none;">
                    <option value="">None</option>
                    {% for cat in lists['categories'] %}
                        <option value="{{ cat }}">{{ cat }}</option>
                    {% endfor %}
                    {% for cat, subs in lists['subcategories'].items() %}
                        {% for sub in subs %}
                            <option value="{{ sub }}">{{ sub }} ({{ cat }})</option>
                        {% endfor %}
                    {% endfor %}
                </select><br><br>

                <label for="edit-glass">Glass:</label>
                <select id="edit-glass" name="glass">
                    <option value="">None</option>
                    {% for glass in lists['glass_types'] %}
                        <option value="{{ glass }}">{{ glass }}</option>
                    {% endfor %}
                </select><br><br>

                <label for="edit-garnish">Garnish:</label>
                <input type="text" id="edit-garnish" name="garnish"><br><br>

                <label for="edit-method">Method:</label>
                <select id="edit-method" name="method">
                    <option value="">None</option>
                    {% for method in lists['methods'] %}
                        <option value="{{ method }}">{{ method }}</option>
                    {% endfor %}
                </select><br><br>

                <label for="edit_ice">Ice:</label>
                <select id="edit_ice" name="Ice">
                    <option value="">None</option>
                    {% for ice in lists['ice_options'] %}
                        <option value="{{ ice }}">{{ ice }}</option>
                    {% endfor %}
                </select><br><br>

                <label for="edit-notes">Notes:</label>
                <textarea id="edit-notes" name="notes"></textarea><br><br>

                <h3>Ingredients</h3>
                <div id="edit-ingredients-list"></div>
                <button type="button" onclick="addIngredient('edit')" style="background-color: #2196F3; color: white; padding: 5px 10px; border: none; border-radius: 4px; cursor: pointer;">Add Ingredient</button><br><br>

                <button type="button" onclick="saveEdit()" style="background-color: #4CAF50; color: white; padding: 10px 20px; border: none; border-radius: 4px; cursor: pointer;">Save Changes</button>
                <button type="button" onclick="closeEditModal()" style="background-color: #ff4444; color: white; padding: 10px 20px; border: none; border-radius: 4px; cursor: pointer;">Cancel</button>
            </form>
        </div>
    </div>

    <div id="add-ingredient-modal" class="modal" style="display: none;">
        <div class="modal-content">
            <span class="close" onclick="document.getElementById('add-ingredient-modal').style.display='none'">×</span>
            <h2>Add New Ingredient</h2>
            <form id="add-ingredient-form">
                <input type="text" id="new-ingredient-name" name="name" placeholder="Ingredient Name" required readonly><br><br>
                <select name="category" id="new-ingredient-category" required>
                    <option value="" disabled selected>Select Category</option>
                    {% for category in lists['categories'] %}
                        <option value="{{ category }}">{{ category }}</option>
                    {% endfor %}
                </select><br><br>
                <select name="sub_category" id="new-ingredient-subcategory">
                    <option value="">None</option>
                </select><br><br>
                <input type="submit" value="Add Ingredient">
            </form>
        </div>
    </div>

    <!-- Delete Confirmation Modal -->
    <div id="delete-modal" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 1000;">
        <div style="position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); background: white; padding: 20px; border-radius: 5px; box-shadow: 0 2px 10px rgba(0,0,0,0.1);">
            <h3>Confirm Deletion</h3>
            <p id="delete-modal-message"></p>
            <button id="confirm-delete" style="background-color: #ff4444; color: white; border: none; padding: 5px 10px; border-radius: 4px; cursor: pointer; margin-right: 10px;">Confirm</button>
            <button id="cancel-delete" style="background-color: #ccc; color: black; border: none; padding: 5px 10px; border-radius: 4px; cursor: pointer;">Cancel</button>
        </div>
    </div>

    <!-- Hidden select for units -->
    <select id="unit-template" style="display: none;">
        {% for unit in lists['units'] %}
            <option value="{{ unit }}">{{ unit }}</option>
        {% endfor %}
    </select>

    <script>
        let ingredientCount = 1;
        let editIngredientCount = 0;
        let currentDrink = null;
        let possibleIngredients = [];
        let allIngredientOptions = []; // Initialize as array

        // Fetch the master list of ingredient names, categories, and subcategories on page load
        document.addEventListener('DOMContentLoaded', function() {
            fetch('/possible-ingredients-json')
                .then(response => {
                    if (!response.ok) {
                        return response.text().then(text => {
                            throw new Error(`HTTP error! Status: ${response.status}, Response: ${text.substring(0, 100)}...`);
                        });
                    }
                    return response.json();
                })
                .then(data => {
                    possibleIngredients = data; // Array of all unique names, categories, and subcategories
                    console.log('Fetched possibleIngredients:', possibleIngredients); // Debug log
                    // Use the data directly as allIngredientOptions, ensuring uniqueness with Set
                    allIngredientOptions = [...new Set(possibleIngredients)].sort(); // Remove duplicates and sort
                    console.log('allIngredientOptions:', allIngredientOptions); // Debug log
                })
                .catch(error => {
                    console.error('Error fetching possible ingredients:', error);
                    allIngredientOptions = []; // Fallback to empty array if fetch fails
                });

            // Delete modal handlers
            document.getElementById('confirm-delete').addEventListener('click', function() {
                if (currentDrink) {
                    deleteRecipe(currentDrink);
                }
            });
            document.getElementById('cancel-delete').addEventListener('click', function() {
                closeDeleteModal();
            });

            // Clear sidebar button handler
            document.getElementById('clear-sidebar').addEventListener('click', function() {
                clearSidebar();
            });

            // Reselect the drink after edit
            const selectedDrink = sessionStorage.getItem('selectedDrink');
            if (selectedDrink) {
                const row = document.querySelector(`#recipes-table tr[data-drink="${selectedDrink}"]`);
                if (row) {
                    showRecipe(row);
                }
                sessionStorage.removeItem('selectedDrink'); // Clear after use
            }

            // Handle Add Ingredient modal form submission
            const addIngredientForm = document.getElementById('add-ingredient-form');
            if (addIngredientForm) {
                addIngredientForm.addEventListener('submit', function(e) {
                    e.preventDefault();
                    const formData = new FormData(this);
                    fetch('/possible-ingredients', {
                        method: 'POST',
                        body: formData
                    })
                        .then(response => {
                            if (!response.ok) {
                                throw new Error(`HTTP error! Status: ${response.status}`);
                            }
                            return response.text();
                        })
                        .then(() => {
                            // Update possibleIngredients and allIngredientOptions
                            const newName = formData.get('name').trim();
                            const newCategory = formData.get('category').trim();
                            const newSubCategory = formData.get('sub_category') || null;
                            possibleIngredients.push(newName);
                            if (newCategory) possibleIngredients.push(newCategory);
                            if (newSubCategory) possibleIngredients.push(newSubCategory);
                            allIngredientOptions = [...new Set(possibleIngredients)].sort();

                            // Update the input field
                            const input = addIngredientForm.dataset.input;
                            if (input) {
                                input.value = newName;
                            }
                            document.getElementById('add-ingredient-modal').style.display = 'none';
                            // Clear the form
                            this.reset();
                            // Reset subcategory select
                            const subcatSelect = document.getElementById('new-ingredient-subcategory');
                            subcatSelect.innerHTML = '<option value="">None</option>';
                            // Hide dropdown
                            const dropdown = input.nextElementSibling;
                            if (dropdown) {
                                dropdown.style.display = 'none';
                            }
                        })
                        .catch(error => {
                            console.error('Error adding ingredient:', error);
                            alert('Error adding ingredient. Check the console for details.');
                        });
                });

                // Dynamically populate subcategories based on selected category
                const categorySelect = document.getElementById('new-ingredient-category');
                const subcategorySelect = document.getElementById('new-ingredient-subcategory');
                categorySelect.addEventListener('change', function() {
                    const category = this.value;
                    subcategorySelect.innerHTML = '<option value="">None</option>'; // Reset to default
                    if (category) {
                        fetch(`/subcategories/${encodeURIComponent(category)}`)
                            .then(response => {
                                if (!response.ok) {
                                    throw new Error(`HTTP error! Status: ${response.status}`);
                                }
                                return response.json();
                            })
                            .then(subcategories => {
                                subcategories.forEach(sub => {
                                    const option = document.createElement('option');
                                    option.value = sub;
                                    option.textContent = sub;
                                    subcategorySelect.appendChild(option);
                                });
                            })
                            .catch(error => {
                                console.error('Error fetching subcategories:', error);
                            });
                    }
                });
            }
        });

        function clearSidebar() {
            document.getElementById('recipe-details').style.display = 'none';
            document.getElementById('no-recipe-selected').style.display = 'block';
            currentDrink = null;
        }

        // Show recipe in sidebar
        window.showRecipe = function(row) {
            const drink = row.getAttribute('data-drink');
            currentDrink = drink;
            console.log('Fetching recipe for:', drink); // Debug log
            fetch(`/recipe/${drink}`)
                .then(response => {
                    console.log('Fetch response status:', response.status); // Debug log
                    if (!response.ok) {
                        throw new Error(`HTTP error! Status: ${response.status}`);
                    }
                    return response.json();
                })
                .then(data => {
                    console.log('Recipe data:', data); // Debug log
                    const nameElement = document.getElementById('recipe-name');
                    const baseSpiritElement = document.getElementById('recipe-base-spirit');
                    const ingredientsList = document.getElementById('recipe-ingredients');
                    const glassElement = document.getElementById('recipe-glass');
                    const garnishElement = document.getElementById('recipe-garnish');
                    const methodElement = document.getElementById('recipe-method');
                    const iceElement = document.getElementById('recipe ice');
                    const notesElement = document.getElementById('recipe-notes');
                    const detailsDiv = document.getElementById('recipe-details');
                    const noRecipeSelected = document.getElementById('no-recipe-selected');

                    if (!nameElement || !baseSpiritElement || !ingredientsList || !glassElement || !garnishElement || !methodElement || !iceElement || !notesElement || !detailsDiv || !noRecipeSelected) {
                        console.error('Missing DOM elements:', {
                            nameElement, baseSpiritElement, ingredientsList, glassElement, garnishElement, methodElement, iceElement, notesElement, detailsDiv, noRecipeSelected
                        });
                        return;
                    }

                    nameElement.textContent = data.name || 'Unknown';
                    baseSpiritElement.textContent = data.base_spirit || 'None';
                    ingredientsList.innerHTML = '';
                    if (data.ingredients && Array.isArray(data.ingredients)) {
                        data.ingredients.forEach(ing => {
                            const li = document.createElement('li');
                            li.textContent = `${ing.quantity || ''} ${ing.unit || ''} ${ing.ingredient || ''}`.trim();
                            ingredientsList.appendChild(li);
                        });
                    } else {
                        console.warn('No valid ingredients array:', data.ingredients);
                    }
                    glassElement.textContent = data.glass || 'None';
                    garnishElement.textContent = data.garnish || 'None';
                    methodElement.textContent = data.method || 'None';
                    iceElement.textContent = data.ice || 'None';
                    notesElement.textContent = data.notes || 'None';
                    detailsDiv.style.display = 'block';
                    noRecipeSelected.style.display = 'none';

                    document.getElementById('edit-recipe').onclick = function() {
                        openEditModal(drink);
                    };
                    document.getElementById('delete-recipe').onclick = function() {
                        const modal = document.getElementById('delete-modal');
                        const message = document.getElementById('delete-modal-message');
                        message.textContent = `Are you sure you want to delete ${drink}?`;
                        modal.style.display = 'block';
                    };
                })
                .catch(error => {
                    console.error('Error fetching recipe:', error);
                    alert('Error fetching recipe details. Check the console for details.');
                });
        };

        // Sorting function
        window.sortTable = function(tableId, colIndex) {
            const table = document.getElementById(tableId);
            const tbody = table.getElementsByTagName('tbody')[0];
            const rows = Array.from(tbody.getElementsByTagName('tr'));
            const header = table.getElementsByTagName('th')[colIndex];
            const currentDirection = header.getAttribute('data-sort') || 'asc';
            const newDirection = currentDirection === 'asc' ? 'desc' : 'asc';

            header.setAttribute('data-sort', newDirection);
            const arrows = table.querySelectorAll('.sort-arrow');
            arrows.forEach(arrow => arrow.textContent = '');
            header.querySelector('.sort-arrow').textContent = newDirection === 'asc' ? '▲' : '▼';

            rows.sort((rowA, rowB) => {
                const cellA = rowA.cells[colIndex].textContent.trim().toLowerCase();
                const cellB = rowB.cells[colIndex].textContent.trim().toLowerCase();
                return newDirection === 'asc' ? cellA.localeCompare(cellB) : cellB.localeCompare(cellA);
            });

            rows.forEach(row => tbody.appendChild(row));
        };

        // Filtering function
        window.filterTable = function() {
            const nameFilter = document.getElementById('filter-name').value.toLowerCase();
            const spiritFilter = document.getElementById('filter-spirit').value.toLowerCase();
            const table = document.getElementById('recipes-table');
            if (!table) return; // Skip if table doesn't exist (no recipes)

            const tbody = table.getElementsByTagName('tbody')[0];
            const rows = tbody.getElementsByTagName('tr');

            for (let i = 0; i < rows.length; i++) {
                const name = rows[i].cells[0].textContent.toLowerCase();
                const spirit = rows[i].cells[1].textContent.toLowerCase();

                const nameMatch = name.includes(nameFilter);
                const spiritMatch = spirit.includes(spiritFilter);

                if (nameMatch && spiritMatch) {
                    rows[i].style.display = '';
                } else {
                    rows[i].style.display = 'none';
                    // Hide sidebar if the current drink is filtered out
                    if (currentDrink && name === currentDrink.toLowerCase()) {
                        document.getElementById('recipe-details').style.display = 'none';
                        document.getElementById('no-recipe-selected').style.display = 'block';
                        currentDrink = null;
                    }
                }
            }
        };

        function openAddModal() {
            document.getElementById('add-modal').style.display = 'block';
            ingredientCount = 1;
            document.getElementById('add-ingredients-list').innerHTML = `
                <div class="ingredient-row">
                    <input type="text" name="ingredient_0" class="ingredient-input" placeholder="Type to search ingredients..." onkeyup="filterIngredients(this, 0)">
                    <div class="ingredient-dropdown" style="display: none; border: 1px solid #ccc; max-height: 150px; overflow-y: auto;"></div>
                    <input type="text" name="quantity_0" placeholder="Quantity" style="width: 100px;">
                    <select name="unit_0">
                        {% for unit in lists['units'] %}
                            <option value="{{ unit }}" {% if unit == 'oz' %}selected{% endif %}>{{ unit }}</option>
                        {% endfor %}
                    </select>
                    <button type="button" onclick="removeIngredient(this)" style="background-color: #ff4444; color: white; border: none; border-radius: 4px; cursor: pointer;">Remove</button>
                </div>
            `;
        }

        function closeAddModal() {
            const form = document.getElementById('add-recipe-form');
            form.reset(); // Clear all form fields
            document.getElementById('add-modal').style.display = 'none';
            // Reset ingredient list to initial state
            ingredientCount = 1;
            document.getElementById('add-ingredients-list').innerHTML = `
                <div class="ingredient-row">
                    <input type="text" name="ingredient_0" class="ingredient-input" placeholder="Type to search ingredients..." onkeyup="filterIngredients(this, 0)">
                    <div class="ingredient-dropdown" style="display: none; border: 1px solid #ccc; max-height: 150px; overflow-y: auto;"></div>
                    <input type="text" name="quantity_0" placeholder="Quantity" style="width: 100px;">
                    <select name="unit_0">
                        {% for unit in lists['units'] %}
                            <option value="{{ unit }}">{{ unit }}</option>
                        {% endfor %}
                    </select>
                    <button type="button" onclick="removeIngredient(this)" style="background-color: #ff4444; color: white; border: none; border-radius: 4px; cursor: pointer;">Remove</button>
                </div>
            `;
        }

        function addIngredient(modalType) {
            const list = document.getElementById(modalType + '-ingredients-list');
            const count = (modalType === 'add' ? ingredientCount++ : editIngredientCount++);
            const row = document.createElement('div');
            row.className = 'ingredient-row';
            row.innerHTML = `
                <input type="text" name="ingredient_${count}" class="ingredient-input" placeholder="Type to search ingredients..." onkeyup="filterIngredients(this, ${count})">
                <div class="ingredient-dropdown" style="display: none; border: 1px solid #ccc; max-height: 150px; overflow-y: auto;"></div>
                <input type="text" name="quantity_${count}" placeholder="Quantity" style="width: 100px;">
                <select name="unit_${count}">
                    {% for unit in lists['units'] %}
                        <option value="{{ unit }}" {% if unit == 'oz' %}selected{% endif %}>{{ unit }}</option>
                    {% endfor %}
                </select>
                <button type="button" onclick="removeIngredient(this)" style="background-color: #ff4444; color: white; border: none; border-radius: 4px; cursor: pointer;">Remove</button>
            `;
            list.appendChild(row);
        }

        function removeIngredient(button) {
            button.parentElement.remove();
        }

        function filterIngredients(input, index) {
            console.log('filterIngredients called for index:', index); // Debug log
            const value = input.value.toLowerCase().trim();
            console.log('Input value:', value); // Debug log
            const dropdown = input.nextElementSibling;
            console.log('Dropdown element:', dropdown); // Debug log
            if (!dropdown || !(dropdown instanceof HTMLElement)) {
                console.error('Invalid dropdown element for input:', input);
                return;
            }
            dropdown.innerHTML = '';
            dropdown.style.display = 'block';

            if (!allIngredientOptions || allIngredientOptions.length === 0) {
                console.warn('allIngredientOptions is empty or not initialized:', allIngredientOptions);
                const div = document.createElement('div');
                div.textContent = 'No ingredients available...';
                div.style.padding = '5px';
                dropdown.appendChild(div);
                return;
            }

            const matches = allIngredientOptions.filter(opt => opt.toLowerCase().includes(value));
            console.log('Matches found:', matches); // Debug log

            if (matches.length > 0) {
                matches.forEach(opt => {
                    const div = document.createElement('div');
                    div.textContent = opt;
                    div.style.padding = '5px';
                    div.style.cursor = 'pointer';
                    div.addEventListener('click', function() {
                        input.value = opt;
                        dropdown.style.display = 'none';
                    });
                    dropdown.appendChild(div);
                });
            }

            if (value && !matches.some(opt => opt.toLowerCase() === value)) {
                const addOption = document.createElement('div');
                addOption.textContent = `Add "${value}"`;
                addOption.style.padding = '5px';
                addOption.style.cursor = 'pointer';
                addOption.style.backgroundColor = '#e0e0e0';
                addOption.addEventListener('click', function(e) {
                    e.preventDefault();
                    openAddIngredientModal(value, input, index);
                });
                dropdown.appendChild(addOption);
            } else if (matches.length === 0) {
                dropdown.style.display = 'none';
            }

            // Hide dropdown when clicking outside
            document.addEventListener('click', function handler(event) {
                if (!input.contains(event.target) && !dropdown.contains(event.target)) {
                    dropdown.style.display = 'none';
                    document.removeEventListener('click', handler);
                }
            });
        }

        function openAddIngredientModal(value, input, index) {
            const modal = document.getElementById('add-ingredient-modal');
            const nameInput = document.getElementById('new-ingredient-name');
            const form = document.getElementById('add-ingredient-form');
            nameInput.value = value;
            form.dataset.input = input;
            form.dataset.index = index;
            modal.style.display = 'block';
        }

        function openEditModal(drink) {
            fetch(`/recipe/${drink}`)
                .then(response => {
                    if (!response.ok) {
                        throw new Error(`HTTP error! Status: ${response.status}`);
                    }
                    return response.json();
                })
                .then(data => {
                    document.getElementById('edit-modal').style.display = 'block';
                    document.getElementById('edit-original-drink').value = data.name || '';
                    document.getElementById('edit-drink').value = data.name || '';
                    const baseSpiritInput = document.getElementById('edit-base_spirit-input');
                    if (baseSpiritInput) {
                        baseSpiritInput.value = data.base_spirit || '';
                    }
                    document.getElementById('edit-base_spirit').value = data.base_spirit || '';
                    document.getElementById('edit-glass').value = data.glass || '';
                    document.getElementById('edit-garnish').value = data.garnish || '';
                    document.getElementById('edit-method').value = data.method || '';
                    const iceInput = document.getElementById('edit_ice');
                    if (iceInput) {
                        iceInput.value = data.ice || '';
                    }
                    document.getElementById('edit-notes').value = data.notes || '';

                    const ingredientsList = document.getElementById('edit-ingredients-list');
                    ingredientsList.innerHTML = '';
                    editIngredientCount = 0;

                    if (data.ingredients && Array.isArray(data.ingredients)) {
                        data.ingredients.forEach((ing, index) => {
                            const row = document.createElement('div');
                            row.className = 'ingredient-row';

                            const templateSelect = document.getElementById('unit-template');
                            const select = templateSelect.cloneNode(true);
                            select.style.display = '';
                            select.id = '';
                            select.name = `unit_${index}`;
                            select.value = ing.unit || 'oz';

                            row.innerHTML = `
                                <input type="text" name="ingredient_${index}" class="ingredient-input" value="${ing.ingredient || ''}" onkeyup="filterIngredients(this, ${index})">
                                <div class="ingredient-dropdown" style="display: none; border: 1px solid #ccc; max-height: 150px; overflow-y: auto;"></div>
                                <input type="text" name="quantity_${index}" value="${ing.quantity || ''}" style="width: 100px;">
                            `;
                            row.appendChild(select);

                            const removeButton = document.createElement('button');
                            removeButton.type = 'button';
                            removeButton.textContent = 'Remove';
                            removeButton.style.backgroundColor = '#ff4444';
                            removeButton.style.color = 'white';
                            removeButton.style.border = 'none';
                            removeButton.style.borderRadius = '4px';
                            removeButton.style.cursor = 'pointer';
                            removeButton.onclick = function() { removeIngredient(this); };
                            row.appendChild(removeButton);
                            ingredientsList.appendChild(row);
                            editIngredientCount = index + 1;
                        });
                    } else {
                        console.error('Invalid ingredients data:', data.ingredients);
                    }
                })
                .catch(error => {
                    console.error('Error fetching recipe:', error);
                    alert('Error fetching recipe details. Check the console for details.');
                });
        }

        function closeEditModal() {
            document.getElementById('edit-modal').style.display = 'none';
        }

        function saveEdit() {
            const form = document.getElementById('edit-recipe-form');
            const iceInput = form.querySelector('#edit_ice');
            const data = {
                original_drink: form.querySelector('#edit-original-drink').value,
                drink: form.querySelector('#edit-drink').value,
                glass: form.querySelector('#edit-glass').value,
                garnish: form.querySelector('#edit-garnish').value,
                method: form.querySelector('#edit-method').value,
                Ice: iceInput ? iceInput.value : '',
                notes: form.querySelector('#edit-notes').value,
                base_spirit: form.querySelector('#edit-base_spirit').value,
                ingredients: []
            };

            const ingredientRows = form.querySelectorAll('#edit-ingredients-list .ingredient-row');
            ingredientRows.forEach(row => {
                const ingredient = row.querySelector(`input[name^="ingredient_"]`).value;
                const quantity = row.querySelector(`input[name^="quantity_"]`).value;
                const unit = row.querySelector(`select[name^="unit_"]`).value;
                if (ingredient && quantity && unit) {
                    data.ingredients.push({ ingredient, quantity, unit });
                }
            });

            const url = `/recipe/edit_recipe/${encodeURIComponent(data.original_drink)}`;
            console.log('Sending request to:', url);
            console.log('Payload:', JSON.stringify(data));

            fetch(url, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(data)
            })
                .then(response => {
                    console.log('Response status:', response.status);
                    if (!response.ok) {
                        return response.text().then(text => {
                            throw new Error(`HTTP error! Status: ${response.status}, Response: ${text}`);
                        });
                    }
                    return response.json();
                })
                .then(result => {
                    console.log('Response data:', result);
                    if (result.success) {
                        showToast("Recipe updated successfully!");
                        closeEditModal();
                        sessionStorage.setItem('selectedDrink', data.drink);
                        setTimeout(() => location.reload(), 1000);
                    } else {
                        showToast(result.message || "Failed to update recipe.");
                        console.error('Update failed:', result.message);
                    }
                })
                .catch(error => {
                    console.error('Fetch error:', error);
                    showToast("Error saving recipe. See console.");
                });
        }

        function deleteRecipe(drink) {
            fetch(`/recipe/delete_recipe/${encodeURIComponent(drink)}`, {
                method: 'DELETE'
            })
                .then(response => {
                    if (!response.ok) {
                        throw new Error(`HTTP error! Status: ${response.status}`);
                    }
                    return response.json();
                })
                .then(data => {
                    closeDeleteModal();
                    location.reload();
                })
                .catch(error => {
                    console.error('Error deleting recipe:', error);
                    alert('Error deleting recipe: ' + error.message);
                    closeDeleteModal();
                });
        }

        function closeDeleteModal() {
            document.getElementById('delete-modal').style.display = 'none';
        }

        function filterBaseSpirit(modalType) {
            const input = document.getElementById(`${modalType}-base_spirit-input`);
            const dropdown = document.getElementById(`${modalType}-base_spirit-dropdown`);
            const select = document.getElementById(`${modalType}-base_spirit`);

            if (!input || !dropdown || !select) {
                console.error(`Missing elements for ${modalType}-base_spirit:`, { input, dropdown, select });
                return;
            }

            const inputValue = input.value.toLowerCase();
            dropdown.innerHTML = '';
            dropdown.style.display = 'block';

            // Collect all options from the select
            const options = Array.from(select.options).slice(1); // Skip the "None" option
            const filteredOptions = options.filter(option => option.value.toLowerCase().includes(inputValue));

            if (filteredOptions.length > 0) {
                filteredOptions.forEach(option => {
                    const div = document.createElement('div');
                    div.textContent = option.text;
                    div.style.padding = '5px';
                    div.style.cursor = 'pointer';
                    div.addEventListener('click', function() {
                        input.value = option.value;
                        select.value = option.value;
                        dropdown.style.display = 'none';
                    });
                    dropdown.appendChild(div);
                });
            } else {
                dropdown.style.display = 'none';
            }

            // Hide dropdown when clicking outside
            document.addEventListener('click', function handler(event) {
                if (input && dropdown && event.target) {
                    if (!input.contains(event.target) && !dropdown.contains(event.target)) {
                        dropdown.style.display = 'none';
                        document.removeEventListener('click', handler);
                    }
                } else {
                    console.error('Invalid elements in click handler:', { input, dropdown, eventTarget: event.target });
                    document.removeEventListener('click', handler);
                }
            });
        }
    </script>

    <style>
        .modal {
            display: none;
            position: fixed;
            z-index: 1;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0,0,0,0.5);
        }
        .modal-content {
            background-color: white;
            margin: 15% auto;
            padding: 20px;
            border: 1px solid #888;
            width: 50%;
        }
        .close {
            color: #aaa;
            float: right;
            font-size: 28px;
            font-weight: bold;
            cursor: pointer;
        }
        .close:hover {
            color: black;
        }
        .ingredient-dropdown div:hover {
            background-color: #f0f0f0;
        }

        table {
            border: 1px solid #ccc;
            margin-bottom: 10px;
        }
        th, td {
            padding: 8px;
            text-align: left;
            border-bottom: 1px solid #ddd;
        }
        th {
            background-color: #f2f2f2;
            cursor: pointer;
        }
        th:hover {
            background-color: #ddd;
        }

        td:hover {
            background-color: #f09898;
        }
        .sort-arrow {
            margin-left: 5px;
        }
    </style>
{% endblock %}